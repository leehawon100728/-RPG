<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìµœê°•ì˜ ê·¼ë³¸ í´ë¦­ RPG</title>
    <style>
        body { background: #121212; color: #dcdcdc; font-family: 'Malgun Gothic', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .auth-container { width: 100%; max-width: 350px; background: #1c1c1c; padding: 30px; border-radius: 10px; border: 1px solid #3a3a3a; margin-top: 50px; }
        #game { display: none; width: 100%; max-width: 450px; background: #1c1c1c; padding: 25px; border-radius: 5px; border: 2px solid #3a3a3a; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        input { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #444; color: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 10px; border: 1px solid #555; background: #333; color: #eee; font-weight: bold; cursor: pointer; border-radius: 4px; }
        button:hover { background: #444; }
        .stats { display: flex; justify-content: space-between; font-size: 15px; background: #252525; padding: 12px; border: 1px solid #444; margin-bottom: 10px; }
        .world-info { text-align: center; color: #55efc4; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .prob-table { width: 100%; font-size: 10px; color: #aaa; margin-bottom: 10px; border-collapse: collapse; text-align: center; background: #1a1a1a; }
        .prob-table th, .prob-table td { border: 1px solid #333; padding: 4px; }
        .weapon-box { text-align: center; padding: 15px; background: #000; border: 1px solid #444; margin-bottom: 15px; }
        .monster-area { background: #2d0000; padding: 15px; border: 1px solid #600; margin-bottom: 10px; text-align: center; }
        .hp-bar { height: 12px; background: #333; border: 1px solid #555; margin-top: 10px; overflow: hidden; }
        #hp-fill { height: 100%; background: #c0392b; width: 100%; transition: 0.1s; }
        .inventory { background: #151515; border: 1px solid #444; padding: 10px; margin-top: 15px; display: none; max-height: 200px; overflow-y: auto; }
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #333; font-size: 11px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .atk-btn { background: #4b4b4b; grid-column: span 2; font-size: 18px; padding: 15px; }
        #log { height: 120px; background: #080808; border: 1px solid #333; padding: 10px; font-size: 12px; overflow-y: auto; margin-top: 15px; color: #999; }
        .rank-ì¼ë°˜ { color: #888; } .rank-í¬ê·€ { color: #3498db; } .rank-ì˜ì›… { color: #9b59b6; }
        .rank-ì‹ í™” { color: #e74c3c; text-shadow: 0 0 5px red; } .rank-ì „ì„¤ { color: #f1c40f; text-shadow: 0 0 15px gold; font-weight: bold; }
        .m-tag { font-size: 11px; font-weight: bold; padding: 2px 8px; border-radius: 10px; display: inline-block; margin-bottom: 5px; }
        .tag-normal { background: #555; } .tag-mini { background: #e67e22; } .tag-boss { background: #c0392b; box-shadow: 0 0 10px #f00; }
        .sell-btn { background: #4a1c1c; color: #ff7675; border: 1px solid #600; padding: 3px 8px; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-screen" class="auth-container">
    <h2 style="text-align: center;">ğŸ”¥ ìµœê°•ì˜ í´ë¦­ RPG ğŸ”¥</h2>
    <input type="text" id="login-id" placeholder="ì•„ì´ë””">
    <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button onclick="handleLogin()">ë¡œê·¸ì¸</button>
    <p onclick="showScreen('signup-screen')" style="text-align:center; font-size:12px; color:#888; cursor:pointer; margin-top:15px;">ì‹ ê·œ íšŒì›ê°€ì…</p>
</div>

<div id="signup-screen" class="auth-container" style="display:none;">
    <h2 style="text-align: center;">íšŒì›ê°€ì…</h2>
    <input type="text" id="signup-id" placeholder="ì•„ì´ë””">
    <input type="password" id="signup-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button onclick="handleSignup()">ê°€ì… ì™„ë£Œ</button>
    <p onclick="showScreen('login-screen')" style="text-align:center; font-size:12px; color:#888; cursor:pointer; margin-top:15px;">ëŒì•„ê°€ê¸°</p>
</div>

<div id="game">
    <div class="world-info" id="world-txt">ë¡œë”© ì¤‘...</div>
    <div class="stats">
        <span>ğŸ’° <b id="gold">0</b></span>
        <span>âš”ï¸ <b id="atk">0</b></span>
        <span>ğŸ« <b id="high-ticket">0</b></span>
    </div>

    <div class="weapon-box">
        <div id="w-rank-text">RANK</div>
        <div><span id="w-type" style="font-size:10px; background:#444; padding:2px 5px; border-radius:3px;">TYPE</span> <b id="w-name" style="font-size:18px;">ë¬´ê¸°</b></div>
        <div id="w-enchant" style="color: #4cd137; font-size: 20px; font-weight:bold;">+0</div>
    </div>

    <div class="monster-area">
        <div id="m-badge" class="m-tag tag-normal">NORMAL</div>
        <div id="m-name" style="font-weight:bold;">ëª¬ìŠ¤í„°</div>
        <div id="m-weak" style="font-size:11px; color:#ff7675;">ë¶„ì„ ì¤‘...</div>
        <div class="hp-bar"><div id="hp-fill"></div></div>
    </div>

    <div class="btn-grid">
        <button class="atk-btn" onclick="attack()">âš”ï¸ ì‚¬ëƒ¥í•˜ê¸°</button>
        <button onclick="enchant()" id="btn-enchant">ğŸ”¥ ê°•í™”</button>
        <button onclick="gacha('normal')" id="btn-gacha-n">âœ¨ ì¼ë°˜ë½‘ê¸°</button>
        <button onclick="gacha('high')" id="btn-gacha-h">ğŸ’ ê³ ê¸‰ë½‘ê¸°</button>
        <button onclick="toggleInv()">ğŸ’ ê°€ë°©/íŒë§¤</button>
        <button onclick="logout()" style="background:#222;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="inventory" class="inventory"><div id="inv-list"></div></div>
    <div id="log">> í™˜ì˜í•©ë‹ˆë‹¤!</div>

    <div style="margin-top:15px; display:flex; flex-direction:column; gap:5px;">
        <span style="font-size:11px; color:#888;">ì¿ í°/ì¹˜íŠ¸ ì½”ë“œ ì…ë ¥</span>
        <div style="display:flex; gap:5px;">
            <input type="text" id="code-input" style="flex:1; padding:10px; margin:0; font-size:12px; background:#000; border:1px solid #444; color:#fff;" placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button onclick="applyCode()" style="width:70px; padding:5px; font-size:12px; background:#333;">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
    const MASTER_KEY = "CLICK_RPG_TOTAL_V3"; 
    let currentUser = null, state = null, curHp = 0, maxHp = 0;

    const synergy = { "ì¹¼": { "ê²©íˆ¬": 2.0, "í™œ": 0.5 }, "í™œ": { "ì§€íŒ¡ì´": 2.0, "ê²©íˆ¬": 0.5 }, "ì§€íŒ¡ì´": { "ì¹¼": 2.0, "ê²©íˆ¬": 0.5 }, "ê²©íˆ¬": { "í™œ": 2.0, "ì§€íŒ¡ì´": 0.5 } };
    const ranks = {
        "ì¼ë°˜": { power: 35, price: 150, chance_n: 65, chance_h: 20 },
        "í¬ê·€": { power: 90, price: 400, chance_n: 25, chance_h: 30 },
        "ì˜ì›…": { power: 220, price: 1200, chance_n: 8, chance_h: 25 },
        "ì‹ í™”": { power: 600, price: 4000, chance_n: 2, chance_h: 18 },
        "ì „ì„¤": { power: 1800, price: 18000, chance_n: 0, chance_h: 7 }
    };

    function showScreen(id) {
        ['login-screen', 'signup-screen', 'game'].forEach(s => document.getElementById(s).style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    function getAnyData(id) {
        const keys = [MASTER_KEY, "CLICK_RPG_FINAL_FIX_V2", "CLICK_RPG_MASTER_FINAL"];
        for(let k of keys) {
            let d = localStorage.getItem(k + id);
            if(d) return JSON.parse(d);
        }
        return null;
    }

    function handleSignup() {
        const id = document.getElementById('signup-id').value.trim(), pw = document.getElementById('signup-pw').value;
        if(!id || !pw) return alert("ë¹ˆì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”.");
        if(getAnyData(id)) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");
        localStorage.setItem(MASTER_KEY + id, JSON.stringify({ pw: pw, gameData: null }));
        alert("ê°€ì… ì„±ê³µ!"); showScreen('login-screen');
    }

    function handleLogin() {
        const id = document.getElementById('login-id').value.trim(), pw = document.getElementById('login-pw').value;
        let userData = getAnyData(id);
        if(!userData || userData.pw !== pw) return alert("ì•„ì´ë”” í˜¹ì€ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.");
        currentUser = id;
        state = userData.gameData || { gold: 0, monsterLvl: 1, inventory: [{ id: Date.now(), name: "ì´ˆë³´ ì¹¼", rank: "ì¼ë°˜", type: "ì¹¼", enchant: 0 }], equippedId: null, mType: "ê²©íˆ¬", gachaCount: 0, usedCoupons: [], highTickets: 0 };
        if(!state.usedCoupons) state.usedCoupons = [];
        if(state.highTickets === undefined) state.highTickets = 0;
        if(!state.equippedId) state.equippedId = state.inventory[0].id;
        showScreen('game'); resetMonster(true); updateUI();
    }

    function resetMonster(isNewType) {
        const sub = ((state.monsterLvl - 1) % 100) + 1;
        const isWorldBoss = sub === 100, isMiniBoss = !isWorldBoss && (sub % 10 === 0);
        let baseHp = (100 + (state.monsterLvl * 65)) * Math.pow(3.5, Math.floor((state.monsterLvl-1)/100));
        const badge = document.getElementById('m-badge');
        if (isWorldBoss) { maxHp = baseHp * 8; badge.innerText = "STAGE BOSS"; badge.className = "m-tag tag-boss"; }
        else if (isMiniBoss) { maxHp = baseHp * 2.5; badge.innerText = "MINI BOSS"; badge.className = "m-tag tag-mini"; }
        else { maxHp = baseHp; badge.innerText = "NORMAL"; badge.className = "m-tag tag-normal"; }
        curHp = maxHp;
        if(isNewType || isMiniBoss || isWorldBoss) state.mType = ["ì¹¼", "í™œ", "ì§€íŒ¡ì´", "ê²©íˆ¬"][Math.floor(Math.random() * 4)];
        document.getElementById('world-txt').innerText = `STORY ${Math.floor((state.monsterLvl-1)/100)+1} (${sub}/100)`;
        document.getElementById('m-name').innerText = isWorldBoss ? `[ë³´ìŠ¤] ì›”ë“œ ìˆ˜í˜¸ì` : (isMiniBoss ? `Lv.${state.monsterLvl} ë„¤ì„ë“œ` : `Lv.${state.monsterLvl} ëª¬ìŠ¤í„°`);
    }

    function attack() {
        const weapon = state.inventory.find(i => i.id === state.equippedId);
        let ratio = synergy[weapon.type][state.mType] || 1.0;
        let pwr = ranks[weapon.rank].power;
        curHp -= (pwr + (weapon.enchant * (pwr * 0.6))) * ratio;
        if(curHp <= 0) {
            let mult = (state.monsterLvl % 100 === 0) ? 50 : ((state.monsterLvl % 10 === 0) ? 5 : 1);
            let rew = Math.floor((40 + (state.monsterLvl * 3)) * mult);
            state.gold += rew;
            log(`ì²˜ì¹˜ ì™„ë£Œ! +${rew.toLocaleString()}G íšë“ğŸ’°`);
            
            // [100ë²ˆì§¸ ë³´ìŠ¤ ë³´ìƒ ì¶”ê°€]
            if(state.monsterLvl % 100 === 0) {
                state.highTickets += 1;
                log(`ğŸ’ ìŠ¤í…Œì´ì§€ ë³´ìŠ¤ ì²˜ì¹˜ ë³´ìƒ: ê³ ê¸‰ ë½‘ê¸°ê¶Œ 1ì¥ ì§€ê¸‰!`);
            }

            state.monsterLvl++; resetMonster(state.monsterLvl % 10 === 1);
        }
        updateUI();
    }

    function gacha(type) {
        if(type === 'high' && state.highTickets > 0) {
            state.highTickets--;
            log("ğŸ« ê³ ê¸‰ ë½‘ê¸°ê¶Œì„ ì‚¬ìš©í•˜ì—¬ ë¬´ê¸°ë¥¼ ë½‘ìŠµë‹ˆë‹¤!");
        } else {
            const cost = (type === 'high' ? 10000 : 1000) + (state.gachaCount * (type === 'high' ? 1000 : 150));
            if(state.gold < cost) return log("ê³¨ë“œ ë¶€ì¡±!");
            state.gold -= cost;
        }
        state.gachaCount++;
        let rand = Math.random() * 100, selectedRank = "ì¼ë°˜", accum = 0;
        for (let r in ranks) { accum += (type === 'high' ? ranks[r].chance_h : ranks[r].chance_n); if (rand <= accum) { selectedRank = r; break; } }
        const t = ["ì¹¼", "í™œ", "ì§€íŒ¡ì´", "ê²©íˆ¬"][Math.floor(Math.random() * 4)];
        state.inventory.push({ id: Date.now(), name: `${selectedRank}ì˜ ${t}`, rank: selectedRank, type: t, enchant: 0 });
        updateUI();
    }

    function enchant() {
        let weapon = state.inventory.find(i => i.id === state.equippedId);
        let cost = 300 + (weapon.enchant * 800);
        if(state.gold < cost) return log("ê³¨ë“œ ë¶€ì¡±!");
        state.gold -= cost;
        if(Math.random() * 100 < (weapon.enchant < 10 ? 80 : 30)) { weapon.enchant++; log("ê°•í™” ì„±ê³µ! âœ¨"); } 
        else log("ê°•í™” ì‹¤íŒ¨. âŒ");
        updateUI();
    }

    function applyCode() {
        const code = document.getElementById('code-input').value.trim();
        if(!code) return;

        // [Happy ì½”ë“œ ì¶”ê°€]
        if(code === "Happy") {
            if(state.usedCoupons.includes("Happy")) {
                alert("ì´ë¯¸ ì‚¬ìš©í•œ ì½”ë“œì…ë‹ˆë‹¤.");
            } else {
                state.gold += 10000;
                state.usedCoupons.push("Happy");
                log("ğŸ ì¿ í° [Happy] ì ìš©: 10,000G íšë“!");
            }
        } else if(code === "191016") {
            state.gold += 1000000;
            log("ğŸ’° ì¹˜íŠ¸ ë°œë™: 1,000,000G!");
        } else {
            log("âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì½”ë“œì…ë‹ˆë‹¤.");
        }
        document.getElementById('code-input').value = "";
        updateUI();
    }

    function updateUI() {
        const weapon = state.inventory.find(i => i.id === state.equippedId);
        document.getElementById('gold').innerText = state.gold.toLocaleString();
        document.getElementById('high-ticket').innerText = state.highTickets;
        let pwr = ranks[weapon.rank].power, ratio = synergy[weapon.type][state.mType] || 1.0;
        document.getElementById('atk').innerText = Math.floor((pwr + (weapon.enchant * (pwr * 0.6))) * ratio).toLocaleString();
        document.getElementById('w-name').innerText = weapon.name;
        document.getElementById('w-name').className = `rank-${weapon.rank}`;
        document.getElementById('w-rank-text').innerText = weapon.rank.toUpperCase();
        document.getElementById('w-rank-text').className = `rank-${weapon.rank}`;
        document.getElementById('w-enchant').innerText = "+" + weapon.enchant;
        document.getElementById('m-weak').innerHTML = `íƒ€ì…: [${state.mType}] (${ratio}x)`;
        document.getElementById('hp-fill').style.width = Math.max(0, (curHp / maxHp * 100)) + "%";
        
        const pn = 1000 + (state.gachaCount * 150), ph = 10000 + (state.gachaCount * 1000), enCost = 300 + (weapon.enchant * 800);
        document.getElementById('btn-gacha-n').innerText = `âœ¨ ì¼ë°˜ (${pn.toLocaleString()}G)`;
        document.getElementById('btn-gacha-h').innerText = state.highTickets > 0 ? `ğŸ« í‹°ì¼“ì‚¬ìš© (${state.highTickets}ì¥)` : `ğŸ’ ê³ ê¸‰ (${ph.toLocaleString()}G)`;
        document.getElementById('btn-enchant').innerText = `ğŸ”¥ ê°•í™” (${enCost.toLocaleString()}G)`;
        renderInv(); save();
    }

    function sellWeapon(id) {
        if (state.inventory.length <= 1 || id === state.equippedId) return;
        const item = state.inventory.find(i => i.id === id);
        let sPrice = Math.floor((ranks[item.rank].price + item.enchant * 800) * 0.5);
        state.gold += sPrice;
        state.inventory = state.inventory.filter(i => i.id !== id);
        updateUI();
    }

    function save() { if(currentUser) localStorage.setItem(MASTER_KEY + currentUser, JSON.stringify({ pw: JSON.parse(localStorage.getItem(MASTER_KEY+currentUser)).pw, gameData: state })); }
    function logout() { location.reload(); }
    function toggleInv() { const i = document.getElementById('inventory'); i.style.display = i.style.display === 'block' ? 'none' : 'block'; }
    function log(m) { const l = document.getElementById('log'); l.innerHTML = `<div>> ${m}</div>` + l.innerHTML; }
    function renderInv() {
        document.getElementById('inv-list').innerHTML = state.inventory.map(item => `
            <div class="inv-item">
                <span class="rank-${item.rank}">[${item.rank}] ${item.type}(+${item.enchant})</span>
                <div><button onclick="state.equippedId=${item.id}; updateUI();">ì¥ì°©</button>
                <button class="sell-btn" onclick="sellWeapon(${item.id})">íŒë§¤</button></div>
            </div>`).join('');
    }
</script>
</body>
</html>
