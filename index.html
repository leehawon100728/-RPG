<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>.RPG</title>
    <style>
        :root { --S: #ff4444; --A: #ffcc00; --B: #44ff44; --C: #888888; --gold: #f59e0b; }
        body { background: #1a1a1a; color: white; font-family: sans-serif; margin: 0; padding: 0; }
        .screen { display: none; padding: 20px; max-width: 600px; margin: auto; }
        .active { display: block; }
        button { cursor: pointer; padding: 10px; background: #444; color: white; border: 1px solid #666; border-radius: 5px; }
        .unit { background: #333; padding: 10px; border-radius: 5px; border: 1px solid #555; cursor: pointer; margin: 5px 0; position: relative; }
        .selected-unit { border: 2px solid var(--gold) !important; background: #443300 !important; }
        .hp-bar { background: #555; height: 10px; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .hp-fill { background: #ff4444; height: 100%; transition: 0.3s; }
        #log { background: #000; height: 120px; overflow-y: auto; padding: 10px; font-size: 12px; border-radius: 5px; margin-top: 10px; display: flex; flex-direction: column; }
      /* ì•„êµ°ê³¼ ì êµ° ì‚¬ì´ì˜ ì¤‘ì•™ ê°„ê²© ë° ì „ì²´ ì •ë ¬ */
.formation-grid { 
    display: flex !important; 
    flex-direction: row !important;
    justify-content: center !important; 
    align-items: center !important; 
    gap: 150px !important; /* ì¤‘ì•™ì„ ì•„ì£¼ ë„“ê²Œ ë²Œë¦¼ */
    margin-top: 50px;
}

/* ì•„êµ° ì˜ì—­: í›„ì—´ì´ ì™¼ìª½, ì „ì—´ì´ ì˜¤ë¥¸ìª½ */
#player-formation {
    display: flex !important;
    flex-direction: row !important; 
    gap: 40px !important;
}

/* ì êµ° ì˜ì—­: ì „ì—´ì´ ì™¼ìª½(ì¤‘ì•™ìª½), í›„ì—´ì´ ì˜¤ë¥¸ìª½ */
#enemy-formation {
    display: flex !important;
    flex-direction: row !important; 
    gap: 40px !important;
}

/* ì„¸ë¡œ ì¤„ ì„¤ì • */
.col { 
    display: flex !important; 
    flex-direction: column !important; 
    gap: 20px; 
    width: 130px; /* ìºë¦­í„° ì¹´ë“œ ë„ˆë¹„ */
    justify-content: center;
    align-items: center;
}

/* ìºë¦­í„° ì¹´ë“œ í¬ê¸° */
.unit { 
    width: 100%;
    background: #333; 
    padding: 20px !important; 
    border-radius: 12px; 
    border: 1px solid #555; 
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
/* ê³µê²© ì• ë‹ˆë©”ì´ì…˜ ë° í•„ì‚´ê¸° íš¨ê³¼ - */
.attack-p { transform: translateX(50px); transition: 0.2s; z-index: 10; }
.attack-e { transform: translateX(-50px); transition: 0.2s; z-index: 10; }
.damaged { animation: shake 0.3s; border: 2px solid red !important; }
@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    50% { transform: translateX(10px); }
    75% { transform: translateX(-10px); }
    100% { transform: translateX(0); }
}
.ultimate-ready { box-shadow: 0 0 15px #fff700; border: 2px solid #fff700 !important; }
/* --- ì†Œí™˜ ì—°ì¶œìš© CSS (ìŠ¤íƒ€ì¼ ë§¨ ì•„ë˜ ì¶”ê°€) --- */

/* 1. ë°°ê²½ì´ ë°¤í•˜ëŠ˜ì²˜ëŸ¼ ì–´ë‘ì›Œì§€ëŠ” íš¨ê³¼ */
@keyframes darken-sky {
    0% { background: #222; }
    100% { background: #050510; }
}

/* 2. ìš´ì„ì´ ìœ„ì—ì„œ ì•„ë˜ë¡œ ë–¨ì–´ì§€ëŠ” ë¬¼ë¦¬ íš¨ê³¼ */
@keyframes meteor-fall {
    0% { transform: translateY(-100vh) scale(0.5); opacity: 1; filter: blur(2px); }
    80% { opacity: 1; }
    100% { transform: translateY(0) scale(1.2); opacity: 0; filter: blur(0px); }
}

/* 3. Sê¸‰ ë‹¹ì²¨ ì‹œ í™”ë©´ í”ë“¤ë¦¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
@keyframes s-rank-shake {
    0%, 100% { transform: scale(1); filter: brightness(1); }
    50% { transform: scale(1.05); filter: brightness(1.2); }
}

/* 4. ì˜ì›… ì´ë¦„ ë“±ì¥ íš¨ê³¼ (ê¸°ì¡´ê³¼ ë™ì¼) */
@keyframes card-appear {
    0% { opacity: 0; transform: translateY(20px) scale(0.9); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

/* ìš´ì„ ëª¨ì–‘ ìŠ¤íƒ€ì¼ (ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©) */
.meteor {
    position: absolute;
    width: 40px;
    height: 40px;
    background: radial-gradient(circle, #ffcc00, #ff6600, transparent);
    border-radius: 50%;
    box-shadow: 0 0 20px #ff6600;
    z-index: 999;
}   
/* --- í›„ì—´ í´ë¦­ íŒì • ê°œì„  --- */
.enemy-unit, .char-box, .unit-card { /* ì‚¬ìš©ìë‹˜ì˜ ì½”ë“œì— ë§ëŠ” í´ë˜ìŠ¤ëª…ìœ¼ë¡œ ìë™ ì ìš©ë˜ê²Œ ì—¬ëŸ¬ ê°œ ë„£ì—ˆìŠµë‹ˆë‹¤ */
    position: relative;
    cursor: pointer;
}

/* í›„ì—´ ìºë¦­í„°ë¥¼ í´ë¦­ ìš°ì„ ìˆœìœ„ 1ë“±ìœ¼ë¡œ ì˜¬ë¦¼ */
.back {
    z-index: 99 !important; 
}

/* ì „ì—´ ìºë¦­í„°ëŠ” ê·¸ë³´ë‹¤ ì•„ë˜ë¡œ */
.front {
    z-index: 10 !important;
}

/* ì´ë¯¸ì§€ì˜ íˆ¬ëª…í•œ ì—¬ë°± ë•Œë¬¸ì— í´ë¦­ì´ ë°©í•´ë°›ì§€ ì•Šë„ë¡ ì„¤ì • */
.enemy-unit img, .unit-card img {
    pointer-events: none; 
}
 </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h2>âš”ï¸ RPG</h2>
        <input type="text" id="uid" style="width:100%; padding:10px; margin-bottom:5px;" placeholder="ì•„ì´ë””">
        <input type="password" id="upw" style="width:100%; padding:10px;" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="handleAuth('login')" style="flex:1">ë¡œê·¸ì¸</button>
            <button onclick="handleAuth('signup')" style="flex:1; background:#444;">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <h2>ğŸ  ë¡œë¹„</h2>
        <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:15px;">
            ğŸ’ ë‹¤ì´ì•„: <span id="crystal-count">0</span> | ğŸ’° ê³¨ë“œ: <span id="gold-count">0</span><br>
            âš”ï¸ ìŠ¤í…Œì´ì§€: <span id="stage-info">1</span>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button onclick="changeScreen('gacha-screen')">âœ¨ ì†Œí™˜</button>
            <button onclick="changeScreen('shop-screen')" style="background:var(--gold); color:black;">ğŸ›’ ì‹œì¥</button>
            <button onclick="changeScreen('inventory-screen')">ğŸ›¡ï¸ ì˜ì›…/í¸ì„±</button>
            <button onclick="startBattle()" style="background:red;">âš”ï¸ ì „íˆ¬ ì‹œì‘</button>
                        <button onclick="changeScreen('ranking-screen')">ğŸ† ë­í‚¹</button>
        </div>
    </div>

    <<div id="gacha-screen" class="screen">
    <h2>âœ¨ ì†Œí™˜ ì œë‹¨</h2>
    
    <div style="text-align:center; margin-bottom:10px;">
        ğŸ’ <span id="gacha-crystals">0</span>
    </div>

    <div id="gacha-area" style="min-height:150px; background:#000; padding:10px; margin-bottom:15px; border-radius:10px; border: 1px solid #333; overflow: hidden; position: relative;">
        <div style="color:#555; text-align:center; margin-top:60px;">ì¤€ë¹„ ì™„ë£Œ...</div>
    </div>

    <div style="display:flex; flex-direction:column; gap:10px;">
        <div style="display:flex; gap:5px;">
            <button onclick="executeGacha('normal', 1)" style="flex:1;">ì¼ë°˜ 1íšŒ (100ğŸ’)</button>
            <button onclick="executeGacha('normal', 11)" style="flex:2;">ì¼ë°˜ 11íšŒ (1000ğŸ’)</button>
        </div>
        <div style="display:flex; gap:5px;">
            <button onclick="executeGacha('high', 1)" style="flex:1; background:var(--gold); color:black; font-weight:bold;">ê³ ê¸‰ 1íšŒ (200ğŸ’)</button>
            <button onclick="executeGacha('high', 11)" style="flex:2; background:var(--gold); color:black; font-weight:bold;">ê³ ê¸‰ 11íšŒ (2000ğŸ’)</button>
        </div>
    </div>

    <div id="gacha-rate-info" style="background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 12px; color: #bbb; line-height: 1.6;">
        <div style="text-align: center; color: var(--gold); font-weight: bold; margin-bottom: 8px; font-size: 14px;">ğŸ”® ì†Œí™˜ í™•ë¥  ì •ë³´</div>
        <div style="display: flex; justify-content: space-around; text-align: center;">
            <div style="flex: 1;">
                <span style="color:white; font-weight:bold;">ê³ ê¸‰ ì†Œí™˜</span><br>
                <span style="color:var(--gold);">Sê¸‰: 10%</span><br>
                <span>Aê¸‰: 30% / Bê¸‰: 60%</span>
            </div>
            <div style="border-left: 1px solid #444; margin: 0 10px;"></div>
            <div style="flex: 1;">
                <span style="color:white; font-weight:bold;">ì¼ë°˜ ì†Œí™˜</span><br>
                <span style="color:violet;">Aê¸‰: 10%</span><br>
                <span>Bê¸‰: 40% / Cê¸‰: 50%</span>
            </div>
        </div>
    </div>

    <button onclick="changeScreen('lobby-screen')" style="width:100%; margin-top:15px; background:none; border: 1px solid #555; color: #888;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

    <<div id="shop-screen" class="screen">
    <h2 style="color:var(--gold);">ğŸ›’ ì•”ì‹œì¥</h2>
    <div style="text-align:center; margin-bottom:10px;">
        ğŸ’° <span id="shop-gold">0</span> | ğŸ’ <span id="shop-crystals">0</span>
    </div>
    <div id="shop-timer" style="color:red; text-align:center; margin-bottom:10px; font-size:12px;"></div>
    
    <div id="special-offers" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;"></div>
    
    <div style="background: #222; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; gap: 15px;">
        
        <div>
            <h4 style="margin: 0 0 10px 0; color:var(--gold);">ğŸ’° ê³¨ë“œ ì¦‰ì‹œ ì¶©ì „ (ë¬´ì œí•œ)</h4>
            <button onclick="buyItem('gold_10k')" style="width:100%; text-align:left; margin-bottom:5px; background:#333; color:white; border:1px solid #444; padding:8px;">
                ğŸ’° 50,000 ê³¨ë“œ (300ğŸ’)
            </button>
            <button onclick="buyItem('gold_50k')" style="width:100%; text-align:left; background:#333; color:white; border:1px solid #444; padding:8px;">
                ğŸ’° 250,000 ê³¨ë“œ (1200ğŸ’) <span style="color:var(--gold); font-size:10px;">HOT!</span>
            </button>
        </div>

        <hr style="border: 0; border-top: 1px solid #444; margin: 5px 0;">

        <div>
            <h4 style="margin: 0 0 10px 0; color:var(--gold);">ğŸ« ì¿ í° ë²ˆí˜¸ ì‚¬ìš©</h4>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="coupon-input" placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                       style="flex: 1; padding: 8px; background: #111; color: white; border: 1px solid #444; border-radius: 5px; font-size: 13px;">
                <button onclick="useCoupon()" style="padding: 8px 15px; background: var(--gold); color: black; font-weight: bold; border: none; border-radius: 5px; cursor: pointer;">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <button onclick="changeScreen('lobby-screen')" style="width:100%; margin-top:20px;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

    <div id="inventory-screen" class="screen">
        <h2>ğŸ›¡ï¸ ì˜ì›… ë° í¸ì„±</h2>
        <div id="hero-list"></div>
        <div id="hero-detail-panel" style="background:#222; padding:15px; border-radius:10px; margin-top:15px; display:none;">
            <h3 id="detail-name" style="color:var(--gold)"></h3>
            <div id="detail-desc" style="font-size:12px; background:#111; padding:10px;"></div>
            <div id="detail-buttons" style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:5px;"></div>
        </div>
        <button onclick="changeScreen('lobby-screen')" style="width:100%; margin-top:10px;">ë¡œë¹„ë¡œ</button>
    </div>

    <div id="battle-screen" class="screen">
        <div class="formation-grid">
            <div id="player-formation" class="col"></div>
            <div id="enemy-formation" class="col" style="flex-direction: row-reverse; display: flex; gap: 10px;"></div>
        </div>
        <div id="battle-controls" style="margin-top:15px;"></div>
        <div id="log"></div>
    </div>

    <div id="dictionary-screen" class="screen">
        <h2>ğŸ“– ì˜ì›… ë„ê°</h2>
        <div id="dict-list" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
        <button onclick="changeScreen('lobby-screen')" style="margin-top:10px;">ë¡œë¹„ë¡œ</button>
    </div>

    <div id="ranking-screen" class="screen">
        <h2>ğŸ† ë­í‚¹</h2>
        <div id="ranking-list" style="background:#111; padding:15px;"></div>
        <button onclick="changeScreen('lobby-screen')" style="margin-top:10px;">ë¡œë¹„ë¡œ</button>
    </div>

<script>
    const DB_KEY = 'GAME_DATA_V12';
    let usersDB = JSON.parse(localStorage.getItem(DB_KEY)) || {};
    let currentUser = null;
    let bData = { active: false, turnIdx: 0, pTeam: [], eTeam: [], selectingTarget: false };
    let shopItems = [];
    let nextRefresh = Date.now() + 600000;

    const TEMPLATES = {
    'S': { 
        'ì´í•˜ì›': { atk: 2500, hp: 10000, desc: "ë°˜ê²©: í”¼ê²© ì‹œ 30% í™•ë¥ ë¡œ ë°ë¯¸ì§€ ë°˜ì‚¬ (1ì„± ì´í›„ ì„±ê¸‰ë‹¹ í™•ë¥  +10%)" }, 
        'íƒ„ì§€ë¡œ': { atk: 2200, hp: 9000, desc: "ì¬ìƒ: ë§¤ í„´ ìµœëŒ€ ì²´ë ¥ì˜ 10% íšŒë³µ (1ì„± ì´í›„ ì„±ê¸‰ë‹¹ íšŒë³µëŸ‰ +5%)" }, 
        'ì¥í™”ì‹ ì€ê³ ì–‘ì´': { atk: 1800, hp: 7500, desc: "ìœ„í˜‘: ì  ì „ì²´ ê³µê²©ë ¥ 10% ê°ì†Œ (1ì„± ì´í›„ ì„±ê¸‰ë‹¹ ê°ì†ŒëŸ‰ +5% )" } 
    },
    'A': { 
        'ë¹…ë”œ': { atk: 1100, hp: 5500, desc: "ë¶ˆì‚¬: ì‚¬ë§ ì‹œ 1íšŒ ë¶€í™œ (1ì„±: ì²´ë ¥ 20%ë¡œ ë¶€í™œ / ì„±ê¸‰ë‹¹ ë¶€í™œ ì²´ë ¥ +20%)" }, 
        'ê²€ê°': { atk: 1300, hp: 4500, desc: "ë¬´íš¨í™”: 5% í™•ë¥ ë¡œ ì  ê³µê²©ì„ íšŒí”¼ (1ì„± ì´í›„ ì„±ê¸‰ë‹¹ í™•ë¥  +2.5%)" } 
    },
    'B': { 
        'ìƒŒë“œë°±': { atk: 200, hp: 9000, desc: "ë”œì€ ì•½í•˜ì§€ë§Œ ì²´ë ¥ì´ ë§¤ìš° ë†’ì•„ ì „ìœ„ì— ë‘ê¸° ì¢‹ìŠµë‹ˆë‹¤." }, 
        'Bê¸‰': { atk: 600, hp: 3500, desc: "í‰ë²”í•œ ëŠ¥ë ¥ì„ ê°€ì§„ ì¼ë°˜ ì „ì‚¬ì…ë‹ˆë‹¤." } 
    },
    'C': { 
        'ë“¤ê°œ': { atk: 300, hp: 2200, desc: "ê¸¸ê±°ë¦¬ì˜ ì•¼ìƒ ë“¤ê°œì…ë‹ˆë‹¤." }, 
        'ì´ìŠ¹ì¬': { atk: 450, hp: 2100, desc: "ê·¸ëƒ¥ íê¸‰ì˜ ì •ì„ì…ë‹ˆë‹¤. (ê¸°ëŒ€í•˜ì§€ ë§ˆì„¸ìš”)" } 
    }
};


    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(usersDB)); }

    function handleAuth(mode) {
        const id = document.getElementById('uid').value, pw = document.getElementById('upw').value;
        if(mode === 'signup') {
            if(usersDB[id]) return alert("ì¤‘ë³µID");
            usersDB[id] = { id, pw, crystals: 2500, gold: 5000, stage: 1, inventory: [], shards: {} };
            saveDB(); alert("ê°€ì… ì„±ê³µ!");
        } else {
            if(usersDB[id] && usersDB[id].pw === pw) { currentUser = usersDB[id]; if(!currentUser.shards) currentUser.shards={}; updateUI(); changeScreen('lobby-screen'); }
            else alert("ì‹¤íŒ¨");
        }
    }

    function updateUI() {
        if(!currentUser) return;
        const cry = currentUser.crystals.toLocaleString();
        const gld = currentUser.gold.toLocaleString();
        document.getElementById('crystal-count').innerText = cry;
        document.getElementById('gold-count').innerText = gld;
        document.getElementById('stage-info').innerText = currentUser.stage;
        if(document.getElementById('gacha-crystals')) document.getElementById('gacha-crystals').innerText = cry;
        if(document.getElementById('shop-crystals')) document.getElementById('shop-crystals').innerText = cry;
        if(document.getElementById('shop-gold')) document.getElementById('shop-gold').innerText = gld;
        saveDB();
    }

    function changeScreen(s) {
        document.querySelectorAll('.screen').forEach(d => d.classList.remove('active'));
        document.getElementById(s).classList.add('active');
        if(s === 'inventory-screen') renderInventory();
        if(s === 'dictionary-screen') renderDictionary();
        if(s === 'ranking-screen') renderRanking();
        if(s === 'shop-screen') { if(shopItems.length===0) refreshShop(); renderShop(); }
        updateUI();
    }

   function executeGacha(type, count) {
    let price = (type === 'high' ? 200 : 100) * (count === 11 ? 10 : count);
    if(currentUser.crystals < price) return alert("ë‹¤ì´ì•„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");

    const results = [];
    let bestRank = 'C';

    for(let i=0; i<count; i++) {
        let rank = type==='high' ? (Math.random()<0.1?'S':(Math.random()<0.4?'A':'B')) : (Math.random()<0.1?'A':(Math.random()<0.5?'B':'C'));
        let keys = Object.keys(TEMPLATES[rank]);
        let name = keys[Math.floor(Math.random()*keys.length)];
        if (rank === 'S') bestRank = 'S';
        results.push({ name, rank, data: TEMPLATES[rank][name] });
    }

    playGachaMotion(bestRank, () => {
        currentUser.crystals -= price;
        const area = document.getElementById('gacha-area');
        area.innerHTML = ""; 

        results.forEach((res, index) => {
            setTimeout(() => {
                const { name, rank, data } = res;
                let html = "";
                
                if(currentUser.inventory.some(h => h.name === name)) {
                    currentUser.shards[name] = (currentUser.shards[name]||0) + 10;
                    html = `<div style="animation: card-appear 0.3s forwards; color:#888;">[ì¡°ê°] ${name}</div>`;
                } else {
                    currentUser.inventory.push({...data, name, rank, lv:1, star:0, selected:false, pos:'front'});
                    let color = rank === 'S' ? '#FFD700' : '#FFFFFF';
                    html = `<div style="animation: card-appear 0.3s forwards; color:${color}; font-weight:bold;">âœ¨ [NEW] ${name}</div>`;
                }
                area.innerHTML += html;
                
                // â˜… ë°”ë¡œ ì´ ë¶€ë¶„ì…ë‹ˆë‹¤! â˜…
                // ëª¨ë“  ì˜ì›…(indexê°€ ë§ˆì§€ë§‰ì¼ ë•Œ)ì´ ë‹¤ í™”ë©´ì— ê·¸ë ¤ì§€ë©´ UIë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
                if (index === results.length - 1) {
                    updateUI(); // ë‚´ ë‹¤ì´ì•„ ìˆ˜ì¹˜ ë“±ì„ í™”ë©´ì— ìƒˆë¡œê³ ì¹¨!
                    if(typeof saveDB === 'function') saveDB(); 
                }
            }, index * 120); 
        });
    });
}

    function renderInventory() {
        const list = document.getElementById('hero-list'); list.innerHTML = "";
        currentUser.inventory.forEach((h, i) => {
            list.innerHTML += `<div class="unit ${h.selected?'selected-unit':''}" onclick="showHeroDetail(${i})"><b>${h.name}</b> (Lv.${h.lv}) [${h.pos==='front'?'ì „ì—´':'í›„ì—´'}]</div>`;
        });
    }

function showHeroDetail(i) {
    const h = currentUser.inventory[i];
    
    // [ìˆ˜ì •] ê¸°ë³¸ 10ë ˆë²¨ + ì„±ê¸‰ë‹¹ 10ë ˆë²¨ ì¶”ê°€ (0ì„±:10, 1ì„±:20, 2ì„±:30...)
    const maxLv = 10 + (h.star * 10); 
    
    document.getElementById('hero-detail-panel').style.display = "block";
    
    const isMax = h.lv >= maxLv;
    document.getElementById('detail-name').innerHTML = `
        ${h.name} (${h.star}ì„±) 
        <span style="font-size:14px; color:${isMax ? '#f87171' : '#aaa'};">
            Lv.${h.lv}/${maxLv}
        </span>
    `;
    
    document.getElementById('detail-desc').innerText = h.desc;

    const sh = currentUser.shards[h.name] || 0; 
    const need = (h.star + 1) * 20;
    const lvCost = h.lv * 500; 

    document.getElementById('detail-buttons').innerHTML = `
        <button onclick="lvUp(${i})" ${isMax ? 'disabled style="background:#555; opacity:0.7;"' : 'style="background:#22c55e;"'}>
            ê°•í™”<br>
            <small style="font-size:10px;">${isMax ? 'í•œê³„ ë„ë‹¬' : 'ë¹„ìš©: ' + lvCost.toLocaleString() + 'G'}</small>
        </button>
        <button onclick="evolve(${i})" ${h.star >= 3 ? 'disabled' : ''}>
            ì§„í™”(${sh}/${h.star >= 3 ? 'MAX' : need})<br>
            <small style="font-size:10px;">ì¡°ê° ì „ìš©</small>
        </button>
        <button onclick="setPos(${i},'front')">ì „ì—´</button>
        <button onclick="setPos(${i},'back')">í›„ì—´</button>
        <button onclick="toggleSelect(${i})" style="grid-column:span 2; background:${h.selected ? '#ef4444' : '#22c55e'}">
            ${h.selected ? 'í•´ì œ' : 'í¸ì„±'}
        </button>`;
}

function lvUp(i) { 
    const h = currentUser.inventory[i];
    
    // [ìˆ˜ì •] ìœ„ì™€ ë˜‘ê°™ì€ ê³µì‹ ì ìš© (0ì„±:10, 1ì„±:20, 2ì„±:30...)
    const maxLv = 10 + (h.star * 10); 
    
    if (h.lv >= maxLv) {
        return alert(`í˜„ì¬ ë ˆë²¨ ì œí•œì€ ${maxLv}ì…ë‹ˆë‹¤.\nì§„í™”í•´ì„œ í•œê³„ë¥¼ ëŒíŒŒí•˜ì„¸ìš”!`);
    }

    const cost = h.lv * 500; 
    if(currentUser.gold < cost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); 
    
    currentUser.gold -= cost; 
    h.lv++; 
    
    if(typeof log === 'function') log(`â¬†ï¸ [ê°•í™”] ${h.name} ë ˆë²¨ì—…! (Lv.${h.lv}) (-${cost}G)`);
    
    if(typeof saveDB === 'function') saveDB();
    else if(typeof saveData === 'function') saveData();
    
    updateUI(); 
    if(typeof renderInventory === 'function') renderInventory(); 
    if(typeof showHeroDetail === 'function') showHeroDetail(i);
}function evolve(i) {
    const h = currentUser.inventory[i];
    const need = (h.star + 1) * 20; // í•„ìš” ì§„í™”ì„(ì¡°ê°)
    const myShards = currentUser.shards[h.name] || 0;

    // ì„±ê¸‰ ì œí•œ ë° ì§„í™”ì„ ì²´í¬ (ê³¨ë“œ ë¹„ìš©ì€ ì‚­ì œí–ˆìŠµë‹ˆë‹¤)
    if (h.star >= 3) return alert("ì´ë¯¸ ìµœëŒ€ ì„±ê¸‰ì…ë‹ˆë‹¤!");
    if (myShards < need) return alert(`ì§„í™”ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (${myShards}/${need})`);

    // ì§„í™”ì„ë§Œ ì°¨ê°
    currentUser.shards[h.name] -= need;
    h.star++;
    
    log(`ğŸŒŸ [ì§„í™”] ${h.name}ì´(ê°€) ${h.star}ì„±ì´ ë˜ì—ˆìŠµë‹ˆë‹¤! (ì§„í™”ì„ ${need}ê°œ ì†Œëª¨)`);
    updateUI();         
    renderInventory();  
    showHeroDetail(i);  
}
    function setPos(i, p) { currentUser.inventory[i].pos = p; renderInventory(); showHeroDetail(i); }
    function toggleSelect(i) { const h = currentUser.inventory[i]; if(!h.selected && currentUser.inventory.filter(x=>x.selected).length >= 5) return alert("ìµœëŒ€ 5ëª…"); h.selected = !h.selected; updateUI(); renderInventory(); showHeroDetail(i); }

   function refreshShop() {
    // 1. ì „ì²´ ì˜ì›… ëª©ë¡ì—ì„œ íŒë§¤ í›„ë³´(Pool) ìƒì„±
    const pool = [];
    for (let r in TEMPLATES) {
        for (let n in TEMPLATES[r]) {
            pool.push({ name: n, rank: r });
        }
    }

    shopItems = [];
    // 2. 4ê°œì˜ ë¬´ì‘ìœ„ ìƒí’ˆ ìƒì„±
    for (let i = 0; i < 4; i++) {
        // ê³¨ë“œ ìƒí’ˆ í™•ë¥  40%
        if (Math.random() < 0.4) { 
            // ğŸ’° [í•µì‹¬] nameì— "750,000"ì„ ì§ì ‘ ì¨ì„œ í‘œì§€ë¥¼ ê°•ì œë¡œ ë°”ê¿‰ë‹ˆë‹¤.
            shopItems.push({ 
                name: "ğŸ’° íŠ¹ê°€ 750,000 ê³¨ë“œ", 
                type: "gold", 
                amount: 750000, 
                price: 3000, 
                stock: 1, 
                rank: "S" 
            });
        } else {
            // ë‚˜ë¨¸ì§€ í™•ë¥ ì€ ëœë¤ ì˜ì›… ì¡°ê° 10ê°œ
            const h = pool[Math.floor(Math.random() * pool.length)];
            const price = h.rank === 'S' ? 2000 : 750;
            shopItems.push({ ...h, type: "shard", amount: 10, price: price, stock: 3 });
        }
    }
    renderShop();
}

function renderShop() {
    const area = document.getElementById('special-offers');
    if (!area) return;
    area.innerHTML = "";

    shopItems.forEach((it, i) => {
        const rankColor = it.rank === 'S' ? 'var(--gold)' : (it.rank === 'A' ? '#a855f7' : '#94a3b8');
        
        // ğŸ’° í™”ë©´ì— ë³´ì´ëŠ” ìˆ˜ëŸ‰ 5ë°° (250,000G)
        const amountText = it.type === 'gold' ? 'ğŸ’° 750,000G' : 'âœ¨ ì¡°ê° 10ê°œ';
        
        area.innerHTML += `
            <div class="unit" style="text-align:center; opacity:${it.stock <= 0 ? 0.5 : 1}; border: 1px solid ${rankColor}">
                <b style="color:${rankColor}">${it.name}</b><br>
                <small style="color:#aaa;">${amountText}</small><br>
                <button onclick="buySpecial(${i})" ${it.stock <= 0 ? 'disabled' : ''} style="width:100%; margin-top:5px;">
                    ${it.stock <= 0 ? 'í’ˆì ˆ' : it.price + 'ğŸ’'}
                </button>
            </div>`;
    });
}    function buySpecial(i) {
    const it = shopItems[i];
    
    // ì¬ê³  í™•ì¸ (í’ˆì ˆ ë°©ì–´)
    if (it.stock <= 0) return alert("ì´ë¯¸ í’ˆì ˆëœ ìƒí’ˆì…ë‹ˆë‹¤.");
    
    // ë‹¤ì´ì•„ ì²´í¬
    if (currentUser.crystals < it.price) return alert("ë‹¤ì´ì•„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");

    // ë‹¤ì´ì•„ ì°¨ê°
    currentUser.crystals -= it.price;
    
    if (it.type === 'gold' || it.name.includes('ê³¨ë“œ')) {
        // ğŸ’° [ìˆ˜ì •] ê¸°ì¡´ 250,000ì˜ 3ë°°ì¸ 750,000ì„ ì§ì ‘ ë”í•´ë²„ë¦½ë‹ˆë‹¤.
        const bonusAmount = 750000; 
        currentUser.gold += bonusAmount;
        log(`ğŸ’° [ì•”ì‹œì¥] 5ë°° ëŒ€ë°•! ${bonusAmount.toLocaleString()} ê³¨ë“œ êµ¬ë§¤ ì„±ê³µ!`);
    } else {
        // ì˜ì›… ì¡°ê° êµ¬ë§¤
        currentUser.shards[it.name] = (currentUser.shards[it.name] || 0) + it.amount;
        log(`âœ¨ [ì•”ì‹œì¥] ${it.name} ì¡°ê° ${it.amount}ê°œ êµ¬ë§¤ ì„±ê³µ!`);
    }

    it.stock--; // ì¬ê³  ê°ì†Œ
    
    // â˜… ì¤‘ìš”: ë°”ë€ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  í™”ë©´ì„ ìƒˆë¡œ ê·¸ë ¤ì•¼ í•©ë‹ˆë‹¤.
    if(typeof saveDB === 'function') saveDB(); 
    else if(typeof saveData === 'function') saveData();
    
    updateUI();   // ìƒë‹¨ë°” ê³¨ë“œ/ë‹¤ì´ì•„ ê°±ì‹ 
    renderShop(); // ìƒì  í’ˆì ˆ í‘œì‹œ ë° ìˆ˜ëŸ‰ ê°±ì‹ 
}
  function buyItem(type) {
    let cost = 0;
    let goldAmount = 0;

  // 1. ì•„ì´í…œë³„ ê°€ê²© ë° ê³¨ë“œ ì§€ê¸‰ëŸ‰ ì„¤ì •
    if (type === 'gold_10k') {
        cost = 300;
        goldAmount = 50000; // ğŸ‘ˆ 10000ì„ 50000ìœ¼ë¡œ ìˆ˜ì •
    } else if (type === 'gold_50k') {
        cost = 1200;
        goldAmount = 250000; // ğŸ‘ˆ 50000ì„ 250000ìœ¼ë¡œ ìˆ˜ì •
    } else if (type === 'shard_s_universal') {
        cost = 1000;
    } else {
        cost = 300; 
    }

    // 2. ë‹¤ì´ì•„ ì”ì•¡ ì²´í¬
    if (currentUser.crystals < cost) return alert("ë‹¤ì´ì•„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");

    // 3. ê²°ì œ ì§„í–‰
    currentUser.crystals -= cost;

    // 4. ë³´ìƒ ì§€ê¸‰ (ê³¨ë“œì¸ê°€ ì¡°ê°ì¸ê°€?)
    if (goldAmount > 0) {
        // ê³¨ë“œ ì•„ì´í…œì¸ ê²½ìš°
        currentUser.gold += goldAmount;
        log(`ğŸ’° [êµ¬ë§¤] ${goldAmount.toLocaleString()} ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤! (-${cost}ğŸ’)`);
    } else {
        // ì¡°ê° ì•„ì´í…œì¸ ê²½ìš°
        const key = type.includes('_s_') ? 'S_UNIVERSAL' : 'A_UNIVERSAL';
        currentUser.shards[key] = (currentUser.shards[key] || 0) + 10;
        log(`âœ¨ [êµ¬ë§¤] ë§ŒëŠ¥ ì¡°ê° 10ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤! (-${cost}ğŸ’)`);
    }

       
    updateUI();
}

    setInterval(() => {
        let rem = nextRefresh - Date.now(); if(rem <= 0) { nextRefresh = Date.now()+600000; refreshShop(); }
        if(document.getElementById('shop-timer')) { let m=Math.floor(rem/60000), s=Math.floor((rem%60000)/1000); document.getElementById('shop-timer').innerText = `ê°±ì‹ ê¹Œì§€: ${m}:${s<10?'0'+s:s}`; }
    }, 1000);

function startBattle() {
    const sel = currentUser.inventory.filter(h => h.selected);
    if(sel.length < 1) return alert("í¸ì„± í•„ìš”");
    
    changeScreen('battle-screen');
    bData.active = true;
    bData.turnIdx = 0;
    bData.teamMP = 0; 

    const isBossStage = currentUser.stage % 5 === 0;

    // ì•„êµ° íŒ€ ìƒì„±
    bData.pTeam = sel.map(h => ({
        ...h, 
        curHP: h.hp + h.lv * 150, 
        maxHP: h.hp + h.lv * 150,
        curMP: 0
    }));

    // ì êµ° íŒ€ ìƒì„±
    if (isBossStage) {
        log(`<b style="color: #ff3300; font-size: 1.1em;">âš ï¸ ë³´ìŠ¤ ë“±ì¥: ëŒ€ì™• ë“¤ê°œê°€ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!</b>`);
        bData.eTeam = [{
            ...TEMPLATES['C']['ë“¤ê°œ'], 
            name: `ğŸ”¥ ëŒ€ì™• ë“¤ê°œ (BOSS)`, 
            curHP: currentUser.stage * 6000,
            maxHP: currentUser.stage * 6000, 
            atk: currentUser.stage * 450, 
            pos: 'front',
            curMP: 0
        }];
    } else {
        bData.eTeam = Array(5).fill(0).map((_, i) => ({
            ...TEMPLATES['C']['ë“¤ê°œ'], 
            name: `ì ${i+1}`, 
            curHP: currentUser.stage * 1500, 
            maxHP: currentUser.stage * 1500, 
            atk: currentUser.stage * 250, 
            pos: i < 3 ? 'front' : 'back',
            curMP: 0
        }));
    }

    // [ê³ ì–‘ì´ íŒ¨ì‹œë¸Œ] ì „íˆ¬ ì‹œì‘ ì§ì „ ì  ê³µê²©ë ¥ ê°ì†Œ ì ìš©
    const cat = bData.pTeam.find(h => h.name === 'ì¥í™”ì‹ ì€ê³ ì–‘ì´');
    if (cat) {
        const star = cat.star || 1;
        const reducePercent = 0.10 + (star - 1) * 0.05; 
        bData.eTeam.forEach(e => {
            e.atk *= (1 - reducePercent);
        });
        log(`ğŸ± [íŒ¨ì‹œë¸Œ] ê³ ì–‘ì´ì˜ ìœ„í˜‘! ì  ê³µê²©ë ¥ì´ ${Math.round(reducePercent * 100)}% ê°ì†Œí–ˆìŠµë‹ˆë‹¤.`);
        
        // í›„ì—´ íƒ€ê²© ë³´ì •: ì „ì—´ì´ ì£½ì–´ë„ íƒ€ê²Ÿì„ ìƒˆë¡œ ì°¾ë„ë¡ ì„¤ì • (ì‹œìŠ¤í…œ í˜¸í™˜ìš©)
        cat.forceTargetUpdate = true;
    }

    updateBattleUI();
    nextTurn(); 
} // <--- ê¹”ë”í•˜ê²Œ ì¤‘ê´„í˜¸ í•˜ë‚˜ë¡œ ë‹«ì•˜ìŠµë‹ˆë‹¤.
function updateBattleUI() {
    const pF = document.getElementById('player-formation'), eF = document.getElementById('enemy-formation');
    const ctrl = document.getElementById('battle-controls');
    if (!pF || !eF || !ctrl) return;
    
    pF.innerHTML = ""; 
    eF.innerHTML = "";

    // 1. [ì•„êµ° ë°°ì¹˜]
    const pB = document.createElement('div'); pB.className = 'col'; 
    const pFr = document.createElement('div'); pFr.className = 'col'; 
    bData.pTeam.forEach((h, i) => {
        const d = createUnitEl(h, bData.turnIdx === i);
        h.pos === 'front' ? pFr.appendChild(d) : pB.appendChild(d);
    });
    pF.append(pB, pFr); 

    // 2. [ì êµ° ë°°ì¹˜ ë° í„°ì¹˜ ë¡œì§]
    const eFr = document.createElement('div'); eFr.className = 'col'; 
    const eB = document.createElement('div'); eB.className = 'col'; 
    
    // í˜„ì¬ ê³µê²© ì¤‘ì¸ ì•„êµ° í™•ì¸
    const attacker = bData.pTeam[bData.turnIdx];

    bData.eTeam.forEach((h, i) => {
        const d = createUnitEl(h, bData.turnIdx === i + 5);
        
        if (bData.selectingTarget && h.curHP > 0) {
            // [ìˆ˜ì • í•µì‹¬] ì´í•˜ì› + í•„ì‚´ê¸°ì¼ ë•Œë§Œ ì „/í›„ì—´ ë¬´ì‹œ ê°€ëŠ¥
            const isHawonSkill = (attacker && attacker.name === 'ì´í•˜ì›' && bData.isSkill);
            const frontAlive = bData.eTeam.some(e => e.pos === 'front' && e.curHP > 0);
            
            // ê³µê²© ê°€ëŠ¥ ì¡°ê±´: ì´í•˜ì› í•„ì‚´ê¸°ê±°ë‚˜, íƒ€ê²Ÿì´ ì „ì—´ì´ê±°ë‚˜, ì „ì—´ì´ ì „ë©¸í–ˆê±°ë‚˜
            let can = isHawonSkill || h.pos === 'front' || !frontAlive;
            
            if (can) {
                d.style.border = "3px solid red";
                d.style.cursor = "pointer";
                d.style.pointerEvents = "auto"; 
                d.style.zIndex = "1000";

                d.querySelectorAll('*').forEach(child => child.style.pointerEvents = 'none');

                d.onclick = (e) => {
                    e.stopPropagation();
                    if (!bData.selectingTarget) return; 
                    bData.selectingTarget = false; 
                    
                    d.style.pointerEvents = "none";
                    d.style.border = "none";
                    
                    console.log("ğŸ¯ ì  í´ë¦­ ì„±ê³µ:", h.name);
                    attack(h, bData.isSkill); 
                };
            } else {
                // ê³µê²© ë¶ˆê°€ëŠ¥í•œ í›„ì—´ ì ë“¤ì€ íë¦¿í•˜ê²Œ í‘œì‹œ
                d.style.opacity = "0.3"; 
                d.style.pointerEvents = "none";
            }
        }
        h.pos === 'front' ? eFr.appendChild(d) : eB.appendChild(d);
    });
    eF.append(eFr, eB);

    // 3. [íƒ€ê²Ÿ ì„ íƒ ì•ˆë‚´ ë° ì·¨ì†Œ ë¡œì§]
    if (bData.selectingTarget) {
        ctrl.innerHTML = `
            <div style="text-align:center; margin-top:10px;">
                <div style="color:red; font-weight:bold;">ğŸ¯ ê³µê²© ëŒ€ìƒì„ í´ë¦­í•˜ì„¸ìš”!</div>
                <button onclick="bData.selectingTarget=false; bData.isSkill=false; nextTurn();" 
                        style="padding:5px 15px; cursor:pointer; background:#444; color:#fff; border-radius:5px; margin-top:5px;">
                    ê³µê²© ì·¨ì†Œ
                </button>
            </div>
        `;
    }
}
function attack(target) {
    if (!bData.active) return;
    
    const attacker = bData.pTeam[bData.turnIdx];
    if (!attacker || attacker.curHP <= 0) return;

    // 1. í•„ì‚´ê¸° ì‚¬ìš© ì‹œ ê²Œì´ì§€ ì†Œëª¨
    if (bData.isSkill) {
        bData.teamMP -= 2;
        log(`ğŸ”¥ <b>${attacker.name}</b>ì˜ í•„ì‚´ê¸° ë°œë™!!`);
    }

    // 2. [íš¨ìœ¨ ëŒ€í­ ê°•í™”] ë°ë¯¸ì§€ ê³„ì‚°ì‹
    // ì„±ê¸‰ë‹¹ 30% ì¦ê°€ + ë ˆë²¨ë‹¹ 20%ì”© ë³µë¦¬ê¸‰ ìƒìŠ¹ (ê¸°ì¡´ 15%ì—ì„œ ë” ì˜¬ë¦¼)
    const starBonus = 1 + (attacker.star - 1) * 0.3; 
    const lvBonus = 1 + (attacker.lv - 1) * 0.20;   
    let damage = Math.floor(attacker.atk * starBonus * lvBonus);

    // 3. ìºë¦­í„°ë³„ íŠ¹ìˆ˜ ìŠ¤í‚¬(í•„ì‚´ê¸°) ë¡œì§
    if (bData.isSkill) {
        if (attacker.name === 'ì´í•˜ì›') {
            if (typeof showHawnSkillEffect === 'function') showHawnSkillEffect();
            applyDamage(target, Math.floor(damage * 5.0));
        } else if (attacker.name === 'íƒ„ì§€ë¡œ') {
            bData.eTeam.forEach(e => { if(e.curHP > 0) applyDamage(e, Math.floor(damage * 2.8)); });
        } else if (attacker.name === 'ì¥í™”ì‹ ì€ê³ ì–‘ì´') {
            const frontAlive = bData.eTeam.some(e => e.pos === 'front' && e.curHP > 0);
            bData.eTeam.forEach(e => {
                if (frontAlive) {
                    if (e.pos === 'front' && e.curHP > 0) applyDamage(e, Math.floor(damage * 3.5));
                } else {
                    if (e.curHP > 0) applyDamage(e, Math.floor(damage * 3.5));
                }
            });
        } else if (attacker.name === 'ë¹…ë”œ') {
            applyDamage(target, Math.floor(damage * 3.0));
        } else if (attacker.name === 'ê²€ê°') {
            bData.eTeam.forEach(e => { if(e.curHP > 0) applyDamage(e, Math.floor(damage * 2.2)); });
        } else {
            applyDamage(target, Math.floor(damage * 2.5));
        }
    } else {
        // ì¼ë°˜ ê³µê²© íƒ€ê²Ÿ ìë™ ë³´ì •
        let finalTarget = target;
        if (!finalTarget || finalTarget.curHP <= 0) {
            finalTarget = bData.eTeam.find(e => e.curHP > 0);
        }
        if (finalTarget) applyDamage(finalTarget, damage);
    }

    // â­ 4. ë¹…ë”œ ë° ê²€ê° ì„±ê¸‰ë³„ ë¶€í™œ ì²´í¬
    bData.pTeam.forEach(hero => {
        const isReviver = hero.name.includes('ë¹…ë”œ') || hero.name.includes('ê²€ê°');
        if (isReviver && hero.curHP <= 0 && !hero.hasRevived) {
            const star = hero.star || 1;
            let revivePercent = 0.2;
            if (star === 2) revivePercent = 0.4;
            else if (star >= 3) revivePercent = 0.6;

            hero.curHP = Math.floor(hero.maxHP * revivePercent);
            hero.hasRevived = true;
            log(`âœ¨ <b style="color: #00ffcc;">[ë¶€í™œ]</b> <b>${hero.name}(${star}ì„±)</b>ì´ ì²´ë ¥ ${Math.round(revivePercent * 100)}%ë¡œ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤!`);
        }
    });

    // 5. ìƒíƒœ ì´ˆê¸°í™” ë° í„´ ë„˜ê¸°ê¸°
    bData.selectingTarget = false;
    bData.isSkill = false;
    bData.turnIdx++; 

    if (!checkEnd()) {
        setTimeout(nextTurn, 500); 
    }
}// ì´í•˜ì› í•„ì‚´ê¸° ì‹œê° ì—°ì¶œ (ì„¤ëª…ì„œ)
function showHawnSkillEffect() {
    // 1. ê°€ìš´ë° ì—°í•˜ê²Œ ë‚˜íƒ€ë‚˜ëŠ” ì»·ì¸ íš¨ê³¼
    const cutin = document.getElementById('skill-cutin');
    if (cutin) {
        cutin.style.opacity = "0.4"; // íˆ¬ëª…ë„ë¥¼ 0.4ë¡œ ì˜¬ë ¤ì„œ ë³´ì´ê²Œ í•¨
        setTimeout(() => { cutin.style.opacity = "0"; }, 700); // 0.7ì´ˆ ë’¤ ë‹¤ì‹œ ìˆ¨ê¹€
    }

    // 2. ì ì´ í„°ì§€ëŠ” ëŠë‚Œì„ ì£¼ëŠ” í™”ë©´ í”ë“¤ë¦¼ íš¨ê³¼
    const screen = document.getElementById('battle-screen') || document.body;
    screen.classList.add('shake-animation'); // CSSì— ì ì–´ë‘” í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
    setTimeout(() => { screen.classList.remove('shake-animation'); }, 400);
}
function applyDamage(target, dmg) {
    if (!target) return;

    // 0. ì´ë¦„ ì¸ì‹ ë³´ì • ë° ê²€ê° íŒ¨ì‹œë¸Œ(ë¬´íš¨í™”) ì²´í¬
    const targetName = target.name ? target.name.trim() : "";
    
    if (targetName.includes('ê²€ê°') && target.curHP > 0) {
        const star = target.star || 1;
        // 5% ê¸°ë³¸ + ì„±ê¸‰ë‹¹ 2.5% ì¶”ê°€ (1ì„± 5%, 2ì„± 7.5%, 3ì„± 10%)
        const avoidChance = 0.05 + (star - 1) * 0.025;

        if (Math.random() < avoidChance) {
            // [ì‹œê° íš¨ê³¼ ì¶”ê°€] ë¡œê·¸ì— ë°°ê²½ìƒ‰ì„ ë„£ê³  í™”ë©´ì„ ë²ˆì©ì´ê²Œ í•¨
            log(`âœ¨ <b style="color: white; background: #2563eb; padding: 2px 5px; border-radius: 3px;">[ë¬´íš¨í™”]</b> <b>ê²€ê°</b>ì´ ê³µê²©ì„ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!`);
            
            const bs = document.getElementById('battle-screen');
            if (bs) {
                bs.style.filter = 'brightness(1.5)'; // í™”ë©´ ìˆœê°„ ë²ˆì©
                setTimeout(() => bs.style.filter = 'brightness(1)', 150);
            }

            if (typeof updateBattleUI === 'function') updateBattleUI();
            return; // ë°ë¯¸ì§€ ì°¨ê° ë‹¨ê³„ë¡œ ê°€ì§€ ì•Šê³  ì¢…ë£Œ
        }
    }

    // 1. ë°ë¯¸ì§€ ì°¨ê°
    target.curHP -= dmg;

    // 2. [ë¶€í™œ ë¡œì§] ë¹…ë”œ í˜¹ì€ ê²€ê°ì´ ì²´ë ¥ì´ 0 ì´í•˜ê°€ ë  ë•Œ ê°€ë¡œì±„ê¸°
    const isReviver = targetName.includes('ë¹…ë”œ') || targetName.includes('ê²€ê°');
    if (isReviver && target.curHP <= 0 && !target.hasRevived) {
        const star = target.star || 1;
        // ì„±ê¸‰ë³„ ë¶€í™œ ì²´ë ¥ ë¹„ìœ¨ ì„¤ì •
        let revivePercent = 0.2;
        if (star === 2) revivePercent = 0.4;
        else if (star >= 3) revivePercent = 0.6;

        const recoverAmount = target.maxHP ? target.maxHP * revivePercent : (target.hp * revivePercent || 500);
        target.curHP = Math.floor(recoverAmount); 
        target.hasRevived = true; 
        
        log(`âœ¨ <b style="color: #00ffcc; font-size: 1.1em;">[ë¶€í™œ]</b> <b>${target.name}</b>ì´(ê°€) ë¶ˆêµ´ì˜ ì˜ì§€ë¡œ ë¶€í™œí–ˆìŠµë‹ˆë‹¤!`);
        
        const bs = document.getElementById('battle-screen');
        if (bs) {
            bs.style.animation = 'shake 0.5s';
            setTimeout(() => bs.style.animation = '', 500);
        }
        
        if (typeof updateBattleUI === 'function') updateBattleUI();
        return; 
    }

    // 3. ì‚¬ë§ ì²˜ë¦¬
    if (target.curHP <= 0) {
        target.curHP = 0;
        log(`ğŸ’€ <b>${target.name}</b>ì´(ê°€) ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤.`);
    } else {
        log(`${target.name}ì—ê²Œ ${Math.round(dmg)}ì˜ í”¼í•´! (ë‚¨ì€ HP: ${target.curHP})`);
    }
    
    if (typeof updateBattleUI === 'function') updateBattleUI();
}
function createUnitEl(h, act) { 
    const d = document.createElement('div'); 
    d.className=`unit ${act?'selected-unit':''}`; 
    // í›„ì—´ ì ì´ ì „ì—´ì— ê°€ë ¤ì ¸ í´ë¦­ ì•ˆë˜ëŠ” ê²ƒ ë°©ì§€
    d.style.position = "relative";
    d.style.zIndex = h.pos === 'back' ? "100" : "10";
    
    d.innerHTML=`<b>${h.name}</b><div class="hp-bar"><div class="hp-fill" style="width:${(h.curHP/h.maxHP)*100}%"></div></div>`; 
    if(h.curHP<=0) d.style.opacity="0.3"; 
    return d; 
}

function nextTurn() {
    if(!bData.active) return;

    // [0] ë¼ìš´ë“œ ì¢…ë£Œ ë° ë¦¬ì…‹ ì²´í¬
    if (bData.turnIdx >= 10) {
        bData.turnIdx = 0;
        bData.roundCharged = false;
    }

    // [1] ìƒˆ ë¼ìš´ë“œ ì‹œì‘ ì‹œ ê²Œì´ì§€ ì¶©ì „
    if(bData.turnIdx === 0 && !bData.roundCharged) {
        bData.teamMP = (Number(bData.teamMP) || 0) + 2;
        bData.roundCharged = true;
        log(`<b>--- [ìƒˆ ë¼ìš´ë“œ] íŒ€ ê²Œì´ì§€ +2 ì¶©ì „ ---</b>`);
    }
    if(bData.turnIdx !== 0) bData.roundCharged = false;

    // [2] ì•„êµ° í„´ ì²˜ë¦¬ (0 ~ 4)
    if(bData.turnIdx < 5) {
        const h = bData.pTeam[bData.turnIdx]; 
        
        // â­ [ë¹…ë”œ ì„±ê¸‰ë³„ ë¶€í™œ ë¡œì§] 0~1ì„±: 20%, 2ì„±: 40%, 3ì„±: 60%
        if (h && h.name.includes('ë¹…ë”œ') && h.curHP <= 0 && !h.hasRevived) {
            const star = h.star || 0; 
            let revivePercent = 0.2; 
            if (star === 2) revivePercent = 0.4;
            else if (star >= 3) revivePercent = 0.6;

            h.curHP = Math.floor(h.maxHP * revivePercent);
            h.hasRevived = true;
            
            log(`âœ¨ <b style="color: #00ffcc;">[ë¶€í™œ]</b> <b>ë¹…ë”œ(${star}ì„±)</b>ì´ ì²´ë ¥ ${Math.round(revivePercent * 100)}%ë¡œ ë¶€í™œí–ˆìŠµë‹ˆë‹¤!`);
            updateBattleUI();
        }

        if(!h || h.curHP <= 0) { 
            bData.turnIdx++; 
            return nextTurn(); 
        } 

        // [íŒ¨ì‹œë¸Œ] íƒ„ì§€ë¡œì˜ ì¬ìƒ
        if (h.name === 'íƒ„ì§€ë¡œ' && h.curHP > 0) {
            const star = h.star || 1;
            const healPercent = 0.10 + (star - 1) * 0.05;
            const healAmount = Math.floor(h.maxHP * healPercent);
            h.curHP = Math.min(h.maxHP, h.curHP + healAmount);
            log(`ğŸŒŠ [íŒ¨ì‹œë¸Œ] íƒ„ì§€ë¡œì˜ ì¬ìƒ! HP ${healAmount} íšŒë³µ.`);
        }

        const canUseSkill = (Number(bData.teamMP) || 0) >= 2;
        
        // â­ [ìŠ¤í‚¬ ì •ë³´ ë°¸ëŸ°ìŠ¤ ì¡°ì •]
        const skillInfo = {
            "ì´í•˜ì›": "ğŸ¯ ëª…ì¡´ì„: ë‹¨ì¼ ëŒ€ìƒì—ê²Œ ì£½ì°½ì„ ê½‚ìŠµë‹ˆë‹¤ (5.0ë°°)",
            "íƒ„ì§€ë¡œ": "ğŸŒŠ ë¬¼ì˜ í˜¸í¡: ì  ì „ì²´ ê´‘ì—­ í”¼í•´ (2.8ë°°)",
            "ì¥í™”ì‹ ì€ê³ ì–‘ì´": "ğŸ¾ ë§ˆêµ¬í• í€´ê¸°: ì•ì¤„(ì—†ìœ¼ë©´ ë’·ì¤„) ì „ì²´ ê³µê²© (3.2ë°°)",
            "ê²€ê°": "âš”ï¸ ë°œë„ìˆ : ì¼ì„¬: ì  ì „ì²´ ê³µê²© (1.8ë°°)",
            "ë¹…ë”œ": "ğŸ‘Š ì§„ì‹¬ í€ì¹˜: ë‹¨ì¼ ëŒ€ìƒì—ê²Œ ê°•ë ¥í•œ í•œ ë°© (2.5ë°°)"
        };

        let html = `
            <div style="color: #00ffff; font-weight: bold; text-align:center;">${h.name}ì˜ ì°¨ë¡€ (ê²Œì´ì§€: ${bData.teamMP})</div>
            <div style="color: #ffcc00; font-size: 0.85em; margin: 4px 0; text-align:center;">${skillInfo[h.name] || "ê°•ë ¥í•œ ì¼ê²©"}</div>
            <div style="display: flex; gap: 5px; justify-content: center;">
                <button onclick="bData.isSkill=false; bData.selectingTarget=true; updateBattleUI();" style="padding: 10px 15px; cursor:pointer; font-weight:bold;">âš”ï¸ ì¼ë°˜</button>
        `;

        if(canUseSkill) {
            html += `<button onclick="bData.isSkill=true; bData.selectingTarget=true; updateBattleUI();" style="background:#ff4444; color:white; padding: 10px 15px; cursor:pointer; font-weight:bold; border:none; border-radius:3px;">ğŸ”¥ í•„ì‚´ê¸°</button>`;
        }
        
        html += `</div>`;
        document.getElementById('battle-controls').innerHTML = html; 
        updateBattleUI();

    } else { 
        // [3] ì êµ° í„´ ì²˜ë¦¬
        const e = bData.eTeam[bData.turnIdx - 5]; 
        if(!e || e.curHP <= 0) { 
            bData.turnIdx++; 
            return nextTurn(); 
        } 
        document.getElementById('battle-controls').innerHTML = `<div style="text-align:center; color:#aaa; margin-top:10px;">ì êµ°(${e.name}) ê³µê²© ì¤‘...</div>`;
        setTimeout(() => {
            if(typeof enemyTurn === 'function') enemyTurn(e);
            else { bData.turnIdx++; nextTurn(); }
        }, 800); 
    }
}function selectTarget(index) {
    if(!bData.selectingTarget) return;
    
    const attacker = bData.pTeam[bData.turnIdx];
    const target = bData.eTeam[index];
    
    if(!target || target.curHP <= 0) return;

    // 1. ì—¬ê¸°ì„œ í•„ì‚´ê¸°ë¥¼ ì“°ê³  ê²Œì´ì§€ë¥¼ ê¹ìŠµë‹ˆë‹¤.
    executeTurn(attacker, 'player', target);
    
    bData.selectingTarget = false;
    bData.turnIdx++; 
    
    // 2. í™”ë©´ì„ ê°±ì‹ í•´ì„œ ê¹ì¸ ê²Œì´ì§€ë¥¼ ë¨¼ì € ë³´ì—¬ì¤ë‹ˆë‹¤.
    updateBattleUI();
    
    // 3. ì•„ì£¼ ì ê¹(0.01ì´ˆ) ì‰¬ì—ˆë‹¤ê°€ ë‹¤ìŒ í„´ì„ ë¶ˆëŸ¬ì„œ ê²Œì´ì§€ ì²´í¬ë¥¼ í™•ì‹¤íˆ í•˜ê²Œ í•©ë‹ˆë‹¤.
    if(!checkEnd()) {
        setTimeout(() => {
            nextTurn();
        }, 10);
    }
}
// 1. ë°ë¯¸ì§€ ê³„ì‚° ë° ê²Œì´ì§€ ì°¨ê° ë‹´ë‹¹
function executeTurn(attacker, team, target, isSkill) {
    if (attacker.curHP <= 0) return;

    // --- [íŒ¨ì‹œë¸Œ: ê²€ê°ì˜ ë¬´íš¨í™”] ---
    // ë°ë¯¸ì§€ ê³„ì‚° ìì²´ë¥¼ ì‹œì‘í•˜ê¸° ì „ì— ì—¬ê¸°ì„œ ë¨¼ì € íŠ•ê²¨ëƒ…ë‹ˆë‹¤.
    if (target && target.name === 'ê²€ê°' && target.curHP > 0) {
        const star = target.star || 1;
        const dodgeChance = 0.05 + (star - 1) * 0.025;
        if (Math.random() < dodgeChance) {
            return log(`âš”ï¸ [íŒ¨ì‹œë¸Œ] ê²€ê°ì´ ê³µê²©ì„ ë¬´íš¨í™”í–ˆìŠµë‹ˆë‹¤!`); // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ(ì•„ë˜ ì½”ë“œ ì‹¤í–‰X)
        }
    }

    const enemies = (team === 'player') ? bData.eTeam : bData.pTeam;
    let finalDamage = 0; 

    // [í•„ì‚´ê¸°/ì¼ë°˜ ê³µê²© ë¡œì§ ì‹œì‘]
    if (team === 'player' && isSkill && (Number(bData.teamMP) >= 2)) {
        bData.teamMP -= 2; 
        const skillData = {
            "ì´í•˜ì›": { skill: "ğŸ‘Š ëª…ì¡´ì„", mult: 4.5, msg: "ë‹˜ì´ ì§„ì˜ ë¬´ì‹œ! ëª…ì¹˜ë¥¼ ëš«ì–´ë²„ë¦½ë‹ˆë‹¤!", type: "snipe" },
            "íƒ„ì§€ë¡œ": { skill: "ğŸŒŠ ë¬¼ì˜ í˜¸í¡", mult: 2.8, msg: "ë‹˜ì´ ì  ì „ì²´ë¥¼ ë² ì–´ ë„˜ê¹ë‹ˆë‹¤!", type: "all" },
            "ì¥í™”ì‹ ì€ê³ ì–‘ì´": { skill: "ğŸ¾ ë§ˆêµ¬í• í€´ê¸°", mult: 3.2, msg: "ë‹˜ì´ ì•ì¤„ì„ ë‚œë„ì§ˆí•©ë‹ˆë‹¤!", type: "row" },
            "ê²€ê°": { skill: "âš”ï¸ ë°œë„ìˆ : ì¼ì„¬", mult: 1.8, msg: "ë‹˜ì´ ì  ì „ì²´ë¥¼ ë² ì–´ ë„˜ê¹ë‹ˆë‹¤!", type: "all" }
        };

        const power = skillData[attacker.name] || { skill: "í•„ì‚´ ê³µê²©", mult: 2.0, msg: "ë‹˜ì´ ê°•ë ¥í•˜ê²Œ ê³µê²©!", type: "single" };
        finalDamage = Math.floor(attacker.atk * power.mult);
        log(`<b style="color: #ffcc00;">[ğŸ”¥TEAM SKILL] ${attacker.name}: ${power.skill}</b>`);

        if (power.type === "all") {
            enemies.forEach(e => { if (e.curHP > 0) e.curHP -= finalDamage; });
        } else if (power.type === "snipe") {
            const alive = enemies.filter(e => e.curHP > 0);
            if(alive.length > 0) {
                const rnd = alive[Math.floor(Math.random() * alive.length)];
                rnd.curHP -= finalDamage;
                target = rnd; 
                log(`ğŸ¯ [ì €ê²©] ${attacker.name}${power.msg}`);
            }
        } else {
            target.curHP -= finalDamage;
            log(`${attacker.name}${power.msg} (ğŸ’¥ ${finalDamage} í”¼í•´!)`);
        }
    } else {
        // ì¼ë°˜ ê³µê²©
        finalDamage = attacker.atk;
        target.curHP -= finalDamage;
        log(`âš”ï¸ ${attacker.name}ì˜ ê³µê²©: ${target.name}ì—ê²Œ ${finalDamage} í”¼í•´.`);
    }

    // --- [íŒ¨ì‹œë¸Œ: ì´í•˜ì› ë°˜ê²© & ë¹…ë”œ ë¶ˆì‚¬] ---
    // ê³µê²©ì´ ì™„ì „íˆ ëë‚œ í›„(í”¼ê°€ ê¹ì¸ í›„) ì²´í¬í•©ë‹ˆë‹¤.
    if (target && target.name === 'ì´í•˜ì›' && target.curHP > 0) {
        if (Math.random() < (0.30 + ((target.star || 1) - 1) * 0.10)) {
            const reflectDmg = Math.floor(finalDamage * 0.5);
            attacker.curHP -= reflectDmg;
            log(`ğŸ¯ [íŒ¨ì‹œë¸Œ] ì´í•˜ì› ë°˜ê²©! ${attacker.name}ì—ê²Œ ${reflectDmg} ë°˜ì‚¬!`);
        }
    }

    if (target && target.name === 'ë¹…ë”œ' && target.curHP <= 0 && !target.hasRevived) {
        const revivePercent = 0.20 + ((target.star || 1) - 1) * 0.20;
        target.curHP = Math.floor(target.maxHP * revivePercent);
        target.hasRevived = true;
        log(`ğŸ”¥ [íŒ¨ì‹œë¸Œ] ë¹…ë”œì˜ ë¶ˆì‚¬! ì²´ë ¥ ${Math.round(revivePercent * 100)}%ë¡œ ë¶€í™œ!`);
    }
}function enemyTurn(e) {
    // ì „ì—´ ìš°ì„  ê³µê²© ë¡œì§
    let ts = bData.pTeam.filter(p => p.curHP > 0 && p.pos === 'front');
    if (ts.length === 0) ts = bData.pTeam.filter(p => p.curHP > 0);
    
    if (ts.length > 0) {
        const target = ts[0];
        // ì êµ° ê³µê²© ì‹œì—ë„ ì• ë‹ˆë©”ì´ì…˜ì„ ì£¼ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì— attack-e í´ë˜ìŠ¤ë¥¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        target.curHP -= e.atk;
        log(`ğŸ’€ [ì ì˜ ê³µê²©] ${e.name} -> ${target.name}ì—ê²Œ ${Math.floor(e.atk)} í”¼í•´!`);
    }
    
    bData.turnIdx = bData.turnIdx >= 9 ? 0 : bData.turnIdx + 1;
    checkEnd();
    updateBattleUI();
    nextTurn();
}
    // [2ë‹¨ê³„] ì „íˆ¬ ì¢…ë£Œ ë° ìŠ¹ë¦¬ íŒì • í•¨ìˆ˜ (ìˆ˜ì •ë³¸)
function checkEnd() { 
    // [íŒ¨ë°° ì¡°ê±´]
    if(bData.pTeam.every(p => p.curHP <= 0)) { 
        alert("íŒ¨ë°°... ìºë¦­í„°ë¥¼ ë” ê°•í™”í•´ë³´ì„¸ìš”!"); 
        bData.active = false; 
        changeScreen('lobby-screen'); 
    } 
    // [ìŠ¹ë¦¬ ì¡°ê±´]
    else if(bData.eTeam.every(e => e.curHP <= 0)) { 
        
        let rewardMsg = "";
        const isBoss = bData.eTeam.some(e => e.isBoss); 

        if (isBoss) {
            const ticketReward = 3;
            const goldReward = currentUser.stage * 1000;
            currentUser.gachaTicket = (currentUser.gachaTicket || 0) + ticketReward;
            currentUser.gold += goldReward;
            rewardMsg = `ğŸŠ ë³´ìŠ¤ ì²˜ì¹˜ ì™„ë£Œ!\në³´ìƒ: ğŸŸï¸ ë¬´ë£Œ ë½‘ê¸°ê¶Œ ${ticketReward}ì¥, ğŸ’° ${goldReward} ê³¨ë“œ`;
        } else {
            const crystalReward = 50; 
            const goldReward = currentUser.stage * 2500; 
            currentUser.crystals += crystalReward; 
            currentUser.gold += goldReward;
            rewardMsg = "ìŠ¹ë¦¬! ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤.";
        }

        alert(rewardMsg);
        
        // ğŸ† [ë­í‚¹ ë°˜ì˜] ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì§í›„ ë­í‚¹ ì—…ë°ì´íŠ¸
        // í˜„ì¬ ìŠ¤í…Œì´ì§€ ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
        updateRanking(currentUser.stage);

        currentUser.stage++; // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ!
        bData.active = false; 
        
        updateUI(); 
        saveDB(); 
        changeScreen('lobby-screen'); 
        
        // ë¡œë¹„ë¡œ ëŒì•„ê°”ì„ ë•Œ ë­í‚¹íŒì„ ìµœì‹ í™”í•©ë‹ˆë‹¤.
        renderRanking();
    } 
}

// [1ë‹¨ê³„] ë­í‚¹ ë°ì´í„° ê´€ë¦¬ (ë‹‰ë„¤ì„ ìš°ì„  ë°˜ì˜ + ìµœê³  ê¸°ë¡ ì—…ë°ì´íŠ¸)
// [1ë‹¨ê³„] ë­í‚¹ ë°ì´í„° ê´€ë¦¬ (ë‹‰ë„¤ì„ ê°•ì œ ë¶€ì—¬ ë¡œì§ í¬í•¨)
function updateRanking(stageScore) {
    try {
        let ranks = JSON.parse(localStorage.getItem('myGameRanks')) || [];

        // 1. ì´ë¦„ ì°¾ê¸° ìˆ˜ì‚¬ëŒ€
        let userNickname = "";
        
        // currentUser ê°ì²´ì—ì„œ ëª¨ë“  ê°€ëŠ¥ì„±ì„ ë’¤ì§‘ë‹ˆë‹¤.
        if (typeof currentUser !== 'undefined' && currentUser) {
            userNickname = currentUser.name || currentUser.nickname || currentUser.id;
        }

        // 2. [ê°•ë ¥ ì¡°ì¹˜] ì´ë¦„ì´ ì—†ê±°ë‚˜ 'ìµëª…'ì´ë©´ íŒì—…ì°½ì„ ë„ì›Œ ì´ë¦„ì„ ì§ì ‘ ë°›ìŠµë‹ˆë‹¤.
        if (!userNickname || userNickname === "ìµëª… ìš©ì‚¬" || userNickname === "undefined") {
            userNickname = prompt("ë­í‚¹ì— ë“±ë¡í•  ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!", "ë¬´ëª…ìš©ì‚¬");
            
            // ì·¨ì†Œë¥¼ ëˆ„ë¥´ê±°ë‚˜ ë¹ˆì¹¸ì´ë©´ ë¬´ì‘ìœ„ ì´ë¦„ ë¶€ì—¬
            if (!userNickname) {
                userNickname = "ìš©ì‚¬" + Math.floor(Math.random() * 999);
            }
            
            // ë‚˜ì¤‘ì— ë˜ ë¬»ì§€ ì•Šê²Œ ë°ì´í„°ì— ì €ì¥
            if (typeof currentUser !== 'undefined') currentUser.name = userNickname;
        }

        // 3. ì¤‘ë³µ ì²´í¬: ì´ë¯¸ ë­í‚¹ì— ê°™ì€ ë‹‰ë„¤ì„ì´ ìˆëŠ”ì§€ í™•ì¸
        const existingIndex = ranks.findIndex(r => r.id === userNickname);

        if (existingIndex !== -1) {
            // ì´ë¯¸ ì¡´ì¬í•œë‹¤ë©´: í˜„ì¬ ìŠ¤í…Œì´ì§€ê°€ ê¸°ì¡´ ê¸°ë¡ë³´ë‹¤ ë†’ì„ ë•Œë§Œ ê°±ì‹ 
            if (stageScore > ranks[existingIndex].score) {
                ranks[existingIndex].score = stageScore;
                ranks[existingIndex].date = new Date().toLocaleDateString();
            }
        } else {
            // ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´: ìƒˆë¡œ ì¶”ê°€
            ranks.push({ 
                id: userNickname, 
                score: stageScore, 
                date: new Date().toLocaleDateString() 
            });
        }

        // 4. ì •ë ¬ ë° ìƒìœ„ 5ê°œ ì €ì¥
        ranks.sort((a, b) => b.score - a.score);
        ranks = ranks.slice(0, 5);

        localStorage.setItem('myGameRanks', JSON.stringify(ranks));
    } catch (e) {
        console.error("ë­í‚¹ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:", e);
    }
}// [2ë‹¨ê³„] ë­í‚¹ í™”ë©´ ì¶œë ¥
function renderRanking() {
    const rankingList = document.getElementById('ranking-list');
    if (!rankingList) return;

    let ranks = [];
    try {
        ranks = JSON.parse(localStorage.getItem('myGameRanks')) || [];
    } catch (e) {
        ranks = [];
    }

    let rankHTML = `
        <div style="color: #ffcc00; font-weight: bold; font-size: 1.1em; margin-bottom: 8px; text-align: center; text-shadow: 1px 1px 2px #000;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (Top 5)</div>
        <div style="padding: 12px; background: rgba(0, 0, 0, 0.5); border-radius: 8px; border: 1px solid #555;">
    `;

    if (ranks.length === 0) {
        rankHTML += `<div style="color: #888; font-size: 0.85em; text-align: center; padding: 10px;">ì•„ì§ í´ë¦¬ì–´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
        ranks.forEach((r, i) => {
            const medal = i === 0 ? "ğŸ¥‡" : i === 1 ? "ğŸ¥ˆ" : i === 2 ? "ğŸ¥‰" : "ğŸ–ï¸";
            // ë°ì´í„° ì˜¤ì—¼ ë°©ì§€ (undefined ë°©ì§€)
            const displayName = (r.id && r.id !== "undefined" && r.id !== "ìµëª… ìš©ì‚¬") ? r.id : "ì´ë¦„ì—†ëŠ” ìš©ì‚¬";
            
            rankHTML += `
                <div style="margin-bottom: 6px; font-size: 0.95em; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 4px;">
                    <span style="color: #fff;">${medal} ${i+1}ìœ„: <b>${displayName}</b></span>
                    <span style="color: #00ffcc; font-weight: bold;">Stage ${r.score}</span>
                </div>
            `;
        });
    }

    rankHTML += `
        </div>
        <div style="font-size: 0.75em; color: #aaa; margin-top: 10px; text-align: center;">
            â€» ìµœê³  ë„ë‹¬ ìŠ¤í…Œì´ì§€ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.
        </div>
    `;

    rankingList.innerHTML = rankHTML;
}// ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜ (ê·¸ëŒ€ë¡œ ìœ ì§€)
function log(msg) {
    const logDiv = document.getElementById('log');
    if (logDiv) {
        const entry = document.createElement('div');
        entry.style.borderBottom = "1px solid #222";
        entry.style.padding = "2px 0";
        entry.innerHTML = msg;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    console.log("GAME_LOG:", msg);
}
function useCoupon() {
    const input = document.getElementById('coupon-input');
    const code = input.value.trim().toUpperCase(); 

    // â˜… [ì¤‘ìš”] ì‚¬ìš©ìê°€ ì¿ í°ì„ ì²˜ìŒ ì“¸ ë•Œ ë°”êµ¬ë‹ˆê°€ ì—†ìœ¼ë©´ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
    if (!currentUser.usedCoupons) {
        currentUser.usedCoupons = [];
    }

    if (!code) return alert("ì¿ í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    
    // ì´ë¯¸ ì‚¬ìš©í•œ ì¿ í°ì¸ì§€ ì²´í¬
    if (currentUser.usedCoupons.includes(code)) {
        return alert("ì´ë¯¸ ì‚¬ìš©í•œ ì¿ í°ì…ë‹ˆë‹¤.");
    }

    let rewardMsg = "";
    
    if (code === "WELCOME2026") {
        currentUser.crystals += 1000;
        currentUser.gold += 3000;
        rewardMsg = "ğŸ í™˜ì˜ ì„ ë¬¼: 1,000ğŸ’ + 3000G";
    } 
    else if (code === "27272727") {
        currentUser.crystals += 1000000;
        rewardMsg = "âœ¨ íŠ¹ë³„";
    }
    else if (code === "LEEHAWON") {
        currentUser.shards["ì´í•˜ì›"] = (currentUser.shards["ì´í•˜ì›"] || 0) + 50;
        rewardMsg = "âš”ï¸ ì´í•˜ì› ì§„í™”ì„ 50ê°œ íšë“!";
    }
    else {
        return alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì¿ í° ë²ˆí˜¸ì…ë‹ˆë‹¤.");
    }

    // ì„±ê³µ ì²˜ë¦¬
    currentUser.usedCoupons.push(code); 
    alert(`ì¿ í° ì‚¬ìš© ì„±ê³µ!\n${rewardMsg}`);
    input.value = ""; 
    
    log(`ğŸ« [ì¿ í°] ${code} ì‚¬ìš© ì™„ë£Œ!`);
    updateUI(); 
}
/* --- ì¿ í° í•¨ìˆ˜ ì¤‘ê´„í˜¸( } ) ë°”ë¡œ ë‹¤ìŒ ì¤„ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” --- */

// [2ë²ˆ] ìš´ì„ ë‚™í•˜ ì—°ì¶œ ì—”ì§„
function playGachaMotion(bestRank, count, callback) {
    const screen = document.body;
    const area = document.getElementById('gacha-area');
    
    // ì•ˆì „ì¥ì¹˜: ë½‘ê¸° ê°œìˆ˜ê°€ ì—†ìœ¼ë©´ 1ê°œë¡œ ì²˜ë¦¬
    const meteorCount = count || 1; 

    area.innerHTML = "<div style='color:white; font-size:18px; text-align:center; padding-top:40px;'>ìš´ëª…ì„ ê²°ì •í•˜ëŠ” ì¤‘...</div>";
    screen.style.pointerEvents = "none"; // ì—°ì¶œ ì¤‘ í´ë¦­ ë°©ì§€
    
    // ë°°ê²½ì´ ì–´ë‘ì›Œì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    screen.style.animation = "darken-sky 1.5s forwards";

    // 1. ìš´ì„ ë–¨ì–´ëœ¨ë¦¬ê¸° ë£¨í”„
    for (let i = 0; i < meteorCount; i++) {
        setTimeout(() => {
            const meteor = document.createElement('div');
            meteor.className = 'meteor'; // CSSì—ì„œ ì„¤ì •í•œ ìš´ì„ ìŠ¤íƒ€ì¼
            meteor.style.left = (Math.random() * 80 + 10) + "%"; 
            meteor.style.top = "40%"; 
            meteor.style.animation = "meteor-fall 0.6s ease-in forwards";
            document.body.appendChild(meteor);

            // ë–¨ì–´ì§„ ìš´ì„ì€ 0.6ì´ˆ ë’¤ ì‚­ì œ
            setTimeout(() => meteor.remove(), 600);
        }, i * 150); // 0.15ì´ˆ ê°„ê²©ìœ¼ë¡œ ì—°ì† ë‚™í•˜
    }

    // 2. ëª¨ë“  ìš´ì„ì´ ë‹¤ ë–¨ì–´ì§„ ì‹œì ì— ê²°ê³¼ ê³µê°œ (ëŒ€ê¸° ì‹œê°„ ê³„ì‚°)
    const totalWaitTime = (meteorCount * 150) + 1000;

    setTimeout(() => {
        screen.style.animation = ""; // ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™”
        
        // Sê¸‰ ë‹¹ì²¨ ì‹œ í™”ë ¤í•œ ë²ˆì©ì„ íš¨ê³¼
        if (bestRank === 'S') {
            screen.style.backgroundColor = "white"; 
            setTimeout(() => { screen.style.backgroundColor = "#222"; }, 100);
            area.style.animation = "s-rank-shake 0.5s 2";
        }

        screen.style.pointerEvents = "auto"; // í´ë¦­ ë°©ì§€ í•´ì œ
        
        // â˜… ì¤‘ìš”: ì—¬ê¸°ì„œ ë‹¤ìŒ ë‹¨ê³„(ê²°ê³¼ ì¶œë ¥)ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
        if (callback) callback(); 
    }, totalWaitTime);
}
// [3ë²ˆ] ê¸°ì¡´ ë½‘ê¸° í•¨ìˆ˜ë¥¼ ëŒ€ì²´í•˜ëŠ” ìƒˆ í•¨ìˆ˜
function executeGacha(type, count) {
    let price = (type === 'high' ? 200 : 100) * (count === 11 ? 10 : count);
    if(currentUser.crystals < price) return alert("ë‹¤ì´ì•„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");

    const results = [];
    let bestRank = 'C';

    // ê²°ê³¼ ë¯¸ë¦¬ ê³„ì‚°
    for(let i=0; i<count; i++) {
        let rank = type==='high' ? (Math.random()<0.1?'S':(Math.random()<0.4?'A':'B')) : (Math.random()<0.1?'A':(Math.random()<0.5?'B':'C'));
        let keys = Object.keys(TEMPLATES[rank]);
        let name = keys[Math.floor(Math.random()*keys.length)];
        if (rank === 'S') bestRank = 'S';
        else if (rank === 'A' && bestRank !== 'S') bestRank = 'A';
        results.push({ name, rank, data: TEMPLATES[rank][name] });
    }

   // ì—°ì¶œ ì‹¤í–‰ (playGachaMotionì— countë¥¼ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤)
    playGachaMotion(bestRank, count, () => {
        currentUser.crystals -= price;
        const area = document.getElementById('gacha-area');
        area.innerHTML = "";

        results.forEach((res, index) => {
            setTimeout(() => {
                const { name, rank, data } = res;
                let html = "";

                if(currentUser.inventory.some(h => h.name === name)) {
                    currentUser.shards[name] = (currentUser.shards[name]||0) + 10;
                    html = `<div style="animation: card-appear 0.3s forwards; color:#888; margin:3px 0;">[ì¡°ê°] ${name} (+10)</div>`;
                } else {
                    currentUser.inventory.push({...data, name, rank, lv:1, star:0, selected:false, pos:'front'});
                    let color = rank === 'S' ? '#FFD700' : (rank === 'A' ? '#DA70D6' : '#FFFFFF');
                    html = `<div style="animation: card-appear 0.3s forwards; color:${color}; font-weight:bold; margin:5px 0; font-size:16px;">âœ¨ [NEW] ${name} (${rank})</div>`;
                }
                area.innerHTML += html;

                if (index === results.length - 1) {
                    updateUI();
                    saveDB();
                }
            }, index * 120);
        });
    });
} // <--- ì‚¬ì§„ì—ì„œ ë¹ ì ¸ìˆë˜ ì´ ì¤‘ê´„í˜¸ê°€ í•µì‹¬ì…ë‹ˆë‹¤!
function executeTurn(attacker, team, target, isSkill) {
    if (!attacker || !target || attacker.curHP <= 0) return;

    // --- [íŒ¨ì‹œë¸Œ 1: ê²€ê° - ë¬´íš¨í™”(íšŒí”¼)] ---
    // ë°ë¯¸ì§€ë¥¼ ì…ê¸° ì „ì— ë¨¼ì € ê²€ì‚¬í•´ì„œ íŠ•ê²¨ëƒ…ë‹ˆë‹¤.
    if (target.name === 'ê²€ê°' && target.curHP > 0) {
        const star = target.star || 1;
        const dodgeChance = 0.05 + (star - 1) * 0.025; // 5% + ì„±ê¸‰ë‹¹ 2.5%
        if (Math.random() < dodgeChance) {
            return log(`âš”ï¸ [íŒ¨ì‹œë¸Œ] ê²€ê°ì´ í™”ë ¤í•œ ê²€ìˆ ë¡œ ê³µê²©ì„ ë¬´íš¨í™”í–ˆìŠµë‹ˆë‹¤!`);
        }
    }

    const enemies = (team === 'player') ? bData.eTeam : bData.pTeam;
    let damage = attacker.atk;

    // í•„ì‚´ê¸° ëª¨ë“œ ë¡œì§
    if (team === 'player' && isSkill && (Number(bData.teamMP) >= 2)) {
        bData.teamMP -= 2;
        const skillData = {
            "ì´í•˜ì›": { skill: "ğŸ‘Š ëª…ì¡´ì„", mult: 4.5, msg: "ë‹˜ì´ ëª…ì¹˜ë¥¼ ëš«ì–´ë²„ë¦½ë‹ˆë‹¤!", type: "snipe" },
            "íƒ„ì§€ë¡œ": { skill: "ğŸŒŠ ë¬¼ì˜ í˜¸í¡", mult: 2.8, msg: "ë‹˜ì´ ì  ì „ì²´ë¥¼ ë²±ë‹ˆë‹¤!", type: "all" },
            "ì¥í™”ì‹ ì€ê³ ì–‘ì´": { skill: "ğŸ¾ ë§ˆêµ¬í• í€´ê¸°", mult: 3.2, msg: "ë‹˜ì´ ì•ì¤„ì„ ë‚œë„ì§ˆí•©ë‹ˆë‹¤!", type: "row" },
            "ê²€ê°": { skill: "âš”ï¸ ë°œë„ìˆ : ì¼ì„¬", mult: 1.8, msg: "ë‹˜ì´ ì  ì „ì²´ë¥¼ ë²±ë‹ˆë‹¤!", type: "all" }
        };

        const power = skillData[attacker.name] || { skill: "í•„ì‚´ ê³µê²©", mult: 2.0, msg: "ë‹˜ì´ ê°•ë ¥ ê³µê²©!", type: "single" };
        damage = Math.floor(attacker.atk * power.mult);
        log(`<b style="color: #ffcc00;">[ğŸ”¥TEAM SKILL] ${attacker.name}: ${power.skill}</b>`);

        if (power.type === "all") {
            enemies.forEach(e => { if (e.curHP > 0) e.curHP -= damage; });
        } else if (power.type === "snipe") {
            const alive = enemies.filter(e => e.curHP > 0);
            if(alive.length > 0) {
                const rnd = alive[Math.floor(Math.random() * alive.length)];
                rnd.curHP -= damage;
                log(`ğŸ¯ [ì €ê²©] ${attacker.name}${power.msg}`);
            }
        } else {
            target.curHP -= damage;
            log(`${attacker.name}${power.msg} (ğŸ’¥ ${damage} í”¼í•´!)`);
        }
    } else {
        // ì¼ë°˜ ê³µê²©
        target.curHP -= damage;
        log(`âš”ï¸ ${attacker.name}ì˜ ê³µê²©: ${target.name}ì—ê²Œ ${damage} í”¼í•´.`);
    }

    // --- [íŒ¨ì‹œë¸Œ 2: ì´í•˜ì› - ë°˜ê²©] ---
    // ë°ë¯¸ì§€ë¥¼ ì…íŒ ì§í›„, ë§ì€ ëŒ€ìƒì´ ì´í•˜ì›ì´ë¼ë©´ ë°˜ê²©í•©ë‹ˆë‹¤.
    if (target.name === 'ì´í•˜ì›' && target.curHP > 0) {
        const star = target.star || 1;
        const reflectChance = 0.30 + (star - 1) * 0.10; // 30% + ì„±ê¸‰ë‹¹ 10%
        if (Math.random() < reflectChance) {
            const reflectDmg = Math.floor(damage * 0.5); // ë°›ì€ í”¼í•´ì˜ 50% ë°˜ì‚¬
            attacker.curHP -= reflectDmg;
            log(`ğŸ¯ [íŒ¨ì‹œë¸Œ] ì´í•˜ì› ë°˜ê²©! ${attacker.name}ì—ê²Œ ${reflectDmg} ë°˜ì‚¬!`);
        }
    }

    // --- [íŒ¨ì‹œë¸Œ 3: ë¹…ë”œ - ë¶ˆì‚¬(ë¶€í™œ)] ---
    // í”¼ê°€ 0 ì´í•˜ê°€ ë˜ì—ˆì„ ë•Œ ë”± í•œ ë²ˆ ì‚´ì•„ë‚©ë‹ˆë‹¤.
    if (target.name === 'ë¹…ë”œ' && target.curHP <= 0 && !target.hasRevived) {
        const star = target.star || 1;
        const revivePercent = 0.20 + (star - 1) * 0.20; // 20% + ì„±ê¸‰ë‹¹ 20%
        target.curHP = Math.floor(target.maxHP * revivePercent);
        target.hasRevived = true; 
        log(`ğŸ”¥ [íŒ¨ì‹œë¸Œ] ë¹…ë”œì˜ ë¶ˆì‚¬ ë°œë™! ì²´ë ¥ ${Math.round(revivePercent * 100)}%ë¡œ ë¶€í™œ!`);
    }
}
// [íŒŒì¼ ë§¨ ì•„ë˜ ì¶”ê°€] ë­í‚¹ ì €ì¥ ë° ì •ë ¬ í•¨ìˆ˜
// [1ë‹¨ê³„] ë­í‚¹ ë°ì´í„° ê´€ë¦¬ (ë‹‰ë„¤ì„ ë°˜ì˜ + 1ì¸ 1ê¸°ë¡ ìœ ì§€)
function updateRanking(newScore) {
    try {
        // 1. ê¸°ì¡´ ë­í‚¹ ê°€ì ¸ì˜¤ê¸°
        let ranks = JSON.parse(localStorage.getItem('myGameRanks')) || [];

        // 2. [ì¤‘ìš”] ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸° (ì´ë¦„ì´ ì—†ìœ¼ë©´ ì ˆëŒ€ ì•ˆë˜ë‹ˆê¹Œ ê°•ì œë¡œ ì°¾ìŒ)
        let userName = "ìµëª… ìš©ì‚¬";
        if (typeof currentUser !== 'undefined' && currentUser) {
            // currentUser.nameì´ë‚˜ nickname ì¤‘ ìˆëŠ” ê²ƒì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            userName = currentUser.name || currentUser.nickname || currentUser.id || "ìµëª… ìš©ì‚¬";
        }

        // 3. ì¤‘ë³µ ì²´í¬: ì´ë¯¸ ë­í‚¹ì— ì´ ë‹‰ë„¤ì„ì´ ìˆëŠ”ì§€ í™•ì¸
        const existingIndex = ranks.findIndex(r => r.id === userName);

        if (existingIndex !== -1) {
            // ì´ë¯¸ ì¡´ì¬í•œë‹¤ë©´: ë‚´ ì˜ˆì „ ê¸°ë¡ë³´ë‹¤ ì§€ê¸ˆ ì ìˆ˜ê°€ ë†’ì„ ë•Œë§Œ 'ê°±ì‹ '
            if (newScore > ranks[existingIndex].score) {
                ranks[existingIndex].score = newScore;
                ranks[existingIndex].date = new Date().toLocaleDateString();
            }
        } else {
            // ë­í‚¹ì— ì²˜ìŒ ì§„ì…í•˜ëŠ” ì´ë¦„ì´ë¼ë©´ ìƒˆë¡œ ì¶”ê°€
            ranks.push({ 
                id: userName, 
                score: newScore, 
                date: new Date().toLocaleDateString() 
            });
        }

        // 4. ì ìˆ˜ ë†’ì€ ìˆœ ì •ë ¬ ë° ìƒìœ„ 5ê°œ ìë¥´ê¸°
        ranks.sort((a, b) => b.score - a.score);
        ranks = ranks.slice(0, 5);

        // 5. ì €ì¥
        localStorage.setItem('myGameRanks', JSON.stringify(ranks));

        // 6. í™”ë©´ ìµœì‹ í™” (í•¨ìˆ˜ ì´ë¦„ì´ displayRankingì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€)
        if (typeof displayRanking === 'function') displayRanking();
        else if (typeof renderRanking === 'function') renderRanking();

    } catch (e) {
        console.error("ë­í‚¹ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
    }
}
// ë­í‚¹ì„ í™”ë©´ì— ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜
function displayRanking() {
    const rankList = document.getElementById('rank-list');
    if (!rankList) return;

    let ranks = JSON.parse(localStorage.getItem('myGameRanks')) || [];
    
    if (ranks.length === 0) {
        rankList.innerHTML = "<li>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
        return;
    }

    rankList.innerHTML = ranks.map((r, i) => `
        <li>${i + 1}ìœ„: ${r.score.toLocaleString()}ì  (${r.date})</li>
    `).join('');
}
// ìºë¦­í„° ë¨¸ë¦¬ ìœ„ì— ê¸€ìë¥¼ ë„ì›Œì£¼ëŠ” í•¨ìˆ˜
function showFloatingText(text, color) {
    const effect = document.createElement('div');
    effect.innerHTML = text;
    effect.style.cssText = `
        position: fixed;
        left: 50%;
        top: 45%;
        transform: translate(-50%, -50%);
        color: ${color};
        font-size: 50px;
        font-weight: bold;
        text-shadow: 2px 2px 10px black;
        z-index: 10000;
        pointer-events: none;
        animation: fadeUpMiss 0.8s forwards;
    `;
    document.body.appendChild(effect);
    setTimeout(() => effect.remove(), 800);
}
</script>
</body>
</html>
